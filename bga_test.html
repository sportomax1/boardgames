<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>Board Game Arena - Boardgames Hub</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f7f7fa;
            color: #222;
        }
        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 2em 1em 1em 1em;
            padding-top: calc(2em + env(safe-area-inset-top));
            padding-bottom: calc(1em + env(safe-area-inset-bottom));
            box-sizing: border-box;
            min-height: 100vh;
        }
        h1 {
            font-size: 1.7em;
            margin-bottom: 1em;
            text-align: center;
            color: #1976d2;
        }
        .search-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            margin-bottom: 1.5em;
            padding: 1em 1.2em;
        }
        .search-input {
            width: 100%;
            font-size: 1.1em;
            padding: 0.8em 1em;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }
        .game-count {
            text-align: center;
            margin: 1em 0;
            font-size: 1em;
            color: #666;
        }
        .game-list {
            margin-top: 1em;
        }
        .game-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            margin-bottom: 1em;
            padding: 1em 1.2em;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .game-thumbnail-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 1em;
            flex-shrink: 0;
        }
        .game-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 0.5em;
            object-fit: cover;
            flex-shrink: 0;
        }
        .status-emoji {
            position: absolute;
            top: 0.5em;
            right: 0.5em;
            font-size: 1.2em;
            z-index: 1;
        }
        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px #0002;
        }
        .game-info {
            flex: 1;
        }
        .game-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 0.3em;
            color: #222;
            line-height: 1.3;
        }
        .game-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }
        .bga-link {
            background: #ff6b35;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.3em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
            min-width: 60px;
            box-sizing: border-box;
        }
        .bga-link:hover {
            background: #e55a2b;
            text-decoration: none;
        }
        .loading {
            text-align: center;
            padding: 2em;
            font-size: 1.1em;
            color: #666;
        }
        .error {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            padding: 1.5em;
            text-align: center;
            color: #d32f2f;
        }
        .back-button {
            background: #666;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0.8em 1.5em;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 1em;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }
        @media (max-width: 480px) {
            .container {
                padding: 1.5em 0.8em 0.8em 0.8em;
                padding-top: calc(1.5em + env(safe-area-inset-top));
            }
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">‚Üê Back to Hub</a>
        <h1>üé≤ Board Game Arena Games</h1>
        
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search BGA games...">
        </div>

        <div class="game-count" id="gameCount"></div>
        
        <div id="loadingDiv" class="loading">üéØ Loading Board Game Arena games...</div>
        <div id="errorDiv" class="error" style="display:none;"></div>
        <div id="gameList" class="game-list"></div>
    </div>

    <script>
        let allGames = [];
        let filteredGames = [];
        let userCollection = {};

        // Load user collection for status emojis and play counts
        async function loadUserCollection() {
            const username = localStorage.getItem('bggUsername') || 'sportomax';
            try {
                const response = await fetch(`https://boardgamegeek.com/xmlapi2/collection?username=${username}&stats=1`);
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                const items = xml.querySelectorAll('item');
                items.forEach(item => {
                    const objectid = item.getAttribute('objectid');
                    const owned = item.querySelector('status')?.getAttribute('own') === '1';
                    const fortrade = item.querySelector('status')?.getAttribute('fortrade') === '1';
                    const want = item.querySelector('status')?.getAttribute('want') === '1';
                    const wanttoplay = item.querySelector('status')?.getAttribute('wanttoplay') === '1';
                    const wanttobuy = item.querySelector('status')?.getAttribute('wanttobuy') === '1';
                    const prevowned = item.querySelector('status')?.getAttribute('prevowned') === '1';
                    const wishlist = item.querySelector('status')?.getAttribute('wishlist') === '1';
                    const numplays = parseInt(item.querySelector('numplays')?.textContent || '0');
                    
                    userCollection[objectid] = {
                        owned, fortrade, want, wanttoplay, wanttobuy, prevowned, wishlist, numplays
                    };
                });
            } catch (error) {
                console.error('Error loading user collection:', error);
            }
        }

        // Get collection status emoji
        function getStatusEmoji(gameId) {
            const status = userCollection[gameId];
            if (!status) return '';
            
            let emojis = [];
            if (status.owned) emojis.push('‚úÖ');
            if (status.wanttoplay) emojis.push('üéÆ');
            if (status.wanttobuy) emojis.push('üõí');
            if (status.want) emojis.push('üîÑ');
            if (status.prevowned) emojis.push('‚è™');
            if (status.fortrade) emojis.push('üì§');
            if (status.wishlist) emojis.push('‚≠ê');
            
            return emojis.join('');
        }

        // Get play count from user collection
        function getPlayCount(gameId) {
            const status = userCollection[gameId];
            return status ? status.numplays : 0;
        }

        // Sort games by BGG rating (descending), then alphabetically
        function sortGamesByRating(games) {
            return games.sort((a, b) => {
                const ratingA = parseFloat(a.rating) || 0;
                const ratingB = parseFloat(b.rating) || 0;
                
                // First sort by rating (descending)
                if (ratingB !== ratingA) {
                    return ratingB - ratingA;
                }
                
                // If ratings are equal, sort alphabetically
                return a.name.localeCompare(b.name);
            });
        }

        // Fetch game details from BGG Thing API
        async function fetchGameDetails(gameId) {
            try {
                const response = await fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${gameId}&stats=1`);
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                const item = xml.querySelector('item');
                const thumbnail = item?.querySelector('thumbnail')?.textContent || '';
                const rank = item?.querySelector('statistics ranks rank[name="boardgame"]')?.getAttribute('value') || 'Unranked';
                const rating = item?.querySelector('statistics rating average')?.getAttribute('value') || 'N/A';
                
                return {
                    thumbnail,
                    rank: rank === 'Not Ranked' ? 'Unranked' : rank,
                    rating: rating !== 'N/A' ? parseFloat(rating).toFixed(1) : 'N/A'
                };
            } catch (error) {
                console.error(`Error fetching details for game ${gameId}:`, error);
                return { thumbnail: '', rank: 'Unranked', rating: 'N/A' };
            }
        }

        // Load BGA games from BoardGameGeek geeklist
        async function loadBGAGames() {
            try {
                // Load user collection first
                await loadUserCollection();
                
                const response = await fetch('https://boardgamegeek.com/xmlapi2/geeklist/140673');
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                // Parse geeklist info
                const geeklist = xml.querySelector('geeklist');
                if (geeklist) {
                    const title = geeklist.querySelector('title')?.textContent;
                    
                    if (title) {
                        document.querySelector('h1').textContent = `üé≤ ${title}`;
                    }
                }
                
                // Parse geeklist items to find games with BGA links
                const items = xml.querySelectorAll('item');
                allGames = Array.from(items).map(item => {
                    const id = item.getAttribute('objectid');
                    const name = item.getAttribute('objectname');
                    const body = item.querySelector('body')?.textContent || '';
                    
                    // Look for BGA URLs in the item body
                    const bgaUrlMatch = body.match(/https:\/\/boardgamearena\.com\/gamepanel\?game=([a-zA-Z0-9_-]+)/);
                    const bgaUrl = bgaUrlMatch ? bgaUrlMatch[0] : null;
                    
                    return {
                        id: id,
                        name: name,
                        thumbnail: '', // Will be loaded later
                        rank: 'Loading...', // Will be loaded later
                        rating: 'Loading...', // Will be loaded later
                        bgaUrl: bgaUrl,
                        bgaGameName: bgaUrlMatch ? bgaUrlMatch[1] : null
                    };
                }).filter(game => game.name && game.name !== ''); // Include all games with names
                
                // Sort games by BGG average rating (highest first), then alphabetically
                sortGamesByRating(allGames);
                
                filteredGames = [...allGames];
                displayGames();
                updateGameCount();
                
                // Load details and thumbnails for visible games
                loadDetailsForVisibleGames();
                
                document.getElementById('loadingDiv').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading BGA games:', error);
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('errorDiv').style.display = 'block';
                document.getElementById('errorDiv').textContent = 'Error loading Board Game Arena games. Please try again later.';
            }
        }

        // Load details for the first batch of visible games
        async function loadDetailsForVisibleGames() {
            const visibleGames = filteredGames.slice(0, 20); // Load first 20 games' details
            let hasUpdates = false;
            
            for (const game of visibleGames) {
                if (!game.thumbnail || game.rank === 'Loading...') {
                    const details = await fetchGameDetails(game.id);
                    game.thumbnail = details.thumbnail;
                    game.rank = details.rank;
                    game.rating = details.rating;
                    hasUpdates = true;
                    
                    // Update the specific game card
                    const gameCard = document.querySelector(`[data-game-id="${game.id}"]`);
                    if (gameCard) {
                        const img = gameCard.querySelector('.game-thumbnail');
                        const rankSpan = gameCard.querySelector('.game-rank');
                        const ratingSpan = gameCard.querySelector('.game-rating');
                        
                        if (img && game.thumbnail) {
                            img.src = game.thumbnail;
                            img.style.display = 'block';
                        }
                        if (rankSpan) {
                            rankSpan.textContent = `Rank: ${game.rank}`;
                        }
                        if (ratingSpan) {
                            ratingSpan.textContent = `Rating: ${game.rating}`;
                        }
                    }
                }
                // Small delay to avoid overwhelming the API
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Re-sort and re-display games after loading ratings
            if (hasUpdates) {
                sortGamesByRating(allGames);
                filteredGames = [...allGames];
                displayGames();
            }
        }

        function displayGames() {
            const gameList = document.getElementById('gameList');
            gameList.innerHTML = '';
            
            filteredGames.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.setAttribute('data-game-id', game.id);
                
                const statusEmoji = getStatusEmoji(game.id);
                const playCount = getPlayCount(game.id);
                const thumbnailDisplay = game.thumbnail ? 
                    `<img src="${game.thumbnail}" alt="${game.name}" class="game-thumbnail">` :
                    `<img src="" alt="${game.name}" class="game-thumbnail" style="display:none;">`;
                
                const bgaButton = game.bgaUrl ? `<a href="${game.bgaUrl}" target="_blank" class="bga-link">üéÆ Play</a>` : '';
                
                gameCard.innerHTML = `
                    ${statusEmoji ? `<div class="status-emoji">${statusEmoji}</div>` : ''}
                    <div class="game-thumbnail-container">
                        ${thumbnailDisplay}
                        ${bgaButton}
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.name}</div>
                        <div class="game-details">
                            <span class="game-rank">Rank: ${game.rank}</span><br>
                            <span class="game-rating">Rating: ${game.rating}</span><br>
                            ${playCount > 0 ? `<span class="play-count">Plays: ${playCount}</span><br>` : ''}
                            BGG ID: ${game.id}
                        </div>
                    </div>
                `;
                
                // Make card clickable to open BGG page (but not the BGA button)
                gameCard.addEventListener('click', (e) => {
                    // Don't open BGG if clicking on the BGA button
                    if (!e.target.classList.contains('bga-link')) {
                        window.open(`https://boardgamegeek.com/boardgame/${game.id}`, '_blank');
                    }
                });
                
                gameList.appendChild(gameCard);
            });
        }

        function updateGameCount() {
            const count = filteredGames.length;
            const total = allGames.length;
            document.getElementById('gameCount').textContent = 
                `Showing ${count} of ${total} games available on Board Game Arena`;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredGames = [...allGames];
            } else {
                filteredGames = allGames.filter(game => 
                    game.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply rating-based sorting to filtered results
            sortGamesByRating(filteredGames);
            
            displayGames();
            updateGameCount();
            
            // Load details for newly filtered games
            if (filteredGames.length <= 20) {
                loadDetailsForVisibleGames();
            }
        });

        // Load games when page loads
        window.addEventListener('load', loadBGAGames);
    </script>
</body>
</html>
