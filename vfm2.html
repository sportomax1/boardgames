<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>Virtual Flea Market (VFM)</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f7f7fa; color: #222; }
        .container { max-width: 430px; margin: 0 auto; padding: 2em 1em 1em 1em; box-sizing: border-box; min-height: 100vh; padding-bottom: env(safe-area-inset-bottom); }
        h1 { font-size: 1.7em; margin-bottom: 1em; text-align: center; }
        .game-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; margin-bottom: 1em; padding: 1em 1.2em; display: flex; flex-direction: row; align-items: center; }
        .game-thumb { width: 64px; height: 64px; border-radius: 10px; margin-right: 1em; object-fit: cover; flex-shrink: 0; }
        .game-info { display: flex; flex-direction: column; flex: 1; }
        .game-title { font-size: 1.1em; font-weight: 600; margin-bottom: 0.2em; }
        .game-details { font-size: 0.98em; color: #555; }
        .geeklist-label { font-size: 0.95em; color: #1976d2; margin-bottom: 0.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Virtual Flea Market (VFM)</h1>
        <div style="margin-bottom:1em; text-align:center; display:flex; flex-direction:row; justify-content:center; align-items:center; gap:0.5em; flex-wrap:wrap;">
            <button id="analyticsBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.5em 0.8em; font-size:0.9em; font-weight:600; cursor:pointer; min-height:36px; -webkit-appearance:none; appearance:none; flex:1;">📊 Stats</button>
            <button id="statusFilterBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.5em 0.8em; font-size:0.9em; font-weight:600; cursor:pointer; min-height:36px; -webkit-appearance:none; appearance:none; flex:1;">🔍 Status</button>
            <button id="sellerFilterBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.5em 0.8em; font-size:0.9em; font-weight:600; cursor:pointer; min-height:36px; -webkit-appearance:none; appearance:none; flex:1;">👤 Seller</button>
            <button id="geeklistFilterBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.5em 0.8em; font-size:0.9em; font-weight:600; cursor:pointer; min-height:36px; -webkit-appearance:none; appearance:none; flex:1;">📋 Lists</button>
            <button id="apiAccessBtn" style="background:#ff9800; color:#fff; border:none; border-radius:8px; padding:0.5em 0.8em; font-size:0.9em; font-weight:600; cursor:pointer; min-height:36px; -webkit-appearance:none; appearance:none; flex:1; display:none;">🔗 APIs</button>
            <select id="statusFilterSelect" style="font-size:1em; padding:0.6em 1em; border-radius:10px; border:1px solid #bbb; display:none; min-height:44px; -webkit-appearance:none; appearance:none;">
                <option value="">All</option>
                <option value="own">✅ Own</option>
                <option value="wanttoplay">🎮 Want to Play</option>
                <option value="wanttobuy">🛒 Want to Buy</option>
                <option value="wantintrade">🔄 Want in Trade</option>
                <option value="prevowned">⏪ Previously Owned</option>
                <option value="tradingaway">📤 Trading Away</option>
                <option value="sold">🔴 Sold Items</option>
                <option value="available">🟢 Available Items</option>
            </select>
            <div id="sellerFilterContainer" style="display:none; position:relative; max-width:250px;">
                <input id="sellerFilterInput" type="text" placeholder="Search sellers..." style="font-size:1em; padding:0.6em 1em; border-radius:10px; border:1px solid #bbb; width:100%; min-height:44px; -webkit-appearance:none; appearance:none; box-sizing:border-box;">
                <div id="sellerSuggestions" style="position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #bbb; border-top:none; border-radius:0 0 10px 10px; max-height:200px; overflow-y:auto; z-index:1000; display:none; box-shadow:0 4px 8px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
        <div id="geeklistFilterPanel" style="display:none; background:#f7f7fa; border-radius:10px; padding:1em; margin-bottom:1em; border:2px solid #8e24aa;">
            <div style="font-weight:600; margin-bottom:0.7em; color:#8e24aa;">Select Geeklists to Include:</div>
            <div id="geeklistCheckboxes" style="display:grid; grid-template-columns:1fr; gap:0.5em;"></div>
            <div style="margin-top:1em; display:flex; gap:0.5em; justify-content:center;">
                <button id="selectAllGeeklists" style="background:#43a047; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; font-size:0.9em; cursor:pointer;">Select All</button>
                <button id="deselectAllGeeklists" style="background:#ff4136; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; font-size:0.9em; cursor:pointer;">Deselect All</button>
                <button id="applyGeeklistFilter" style="background:#8e24aa; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; font-size:0.9em; cursor:pointer; font-weight:600;">Apply Filter</button>
            </div>
        </div>
        <div id="apiAccessPanel" style="display:none; background:#fff5e6; border-radius:10px; padding:1em; margin-bottom:1em; border:2px solid #ff9800;">
            <div style="font-weight:600; margin-bottom:0.7em; color:#ff9800;">🔗 API Access & URLs</div>
            <div style="font-size:0.9em; margin-bottom:1em; color:#666;">Copy API calls and geeklist URLs for the loaded data:</div>
            <div id="loadedGeeklistsContainer" style="display:grid; gap:0.8em;"></div>
        </div>
        <div id="filterBar" style="margin-bottom:1em; text-align:center;">
            <input id="filterInput" type="text" placeholder="Filter by name..." style="font-size:1.1em; padding:0.6em 1em; border-radius:10px; border:1px solid #bbb; width:70%; max-width:200px; margin-bottom:0.7em; -webkit-appearance:none; appearance:none;">
            <div style="display:flex; justify-content:center; gap:0.4em; flex-wrap:wrap;">
                <button id="exactMatchBtn" data-mode="exact" style="background:#666; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; font-size:0.9em; min-height:36px; cursor:pointer; font-weight:500; -webkit-appearance:none; appearance:none;">Exact Match</button>
                <button id="startsWithBtn" data-mode="startswith" style="background:#666; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; font-size:0.9em; min-height:36px; cursor:pointer; font-weight:500; -webkit-appearance:none; appearance:none;">Starts With</button>
                <button id="containsBtn" data-mode="contains" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; font-size:0.9em; min-height:36px; cursor:pointer; font-weight:500; -webkit-appearance:none; appearance:none;">Contains</button>
            </div>
        </div>
        <div id="gamesCardWrapper">
            <div id="geeklistSelector" style="background:#fff; border-radius:12px; padding:1.5em; margin-bottom:1em; box-shadow: 0 2px 12px #0001;">
                <h3 style="margin-top:0; margin-bottom:1em; color:#1976d2;">Select Geeklists to Load</h3>
                <div id="geeklistOptions" style="display:grid; gap:0.8em;"></div>
                <div style="margin-top:1.5em; display:flex; gap:0.5em; flex-wrap:wrap; justify-content:center;">
                    <button id="selectAllBtn" style="background:#43a047; color:#fff; border:none; border-radius:8px; padding:0.6em 1em; font-size:0.9em; cursor:pointer; font-weight:600;">Select All</button>
                    <button id="deselectAllBtn" style="background:#ff4136; color:#fff; border:none; border-radius:8px; padding:0.6em 1em; font-size:0.9em; cursor:pointer; font-weight:600;">Deselect All</button>
                    <button id="loadSelectedBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.6em 1.5em; font-size:1em; cursor:pointer; font-weight:600; min-height:44px;">Load Selected Geeklists</button>
                </div>
            </div>
        </div>
        <div id="loadMoreWrapper" style="text-align:center; margin:1em 0;"></div>
    </div>
    <script>
    const geeklists = [
        { id: 363504, name: "BGG.CON VFM 2025" },
        { id: 342440, name: "BGG.CON VFM 2024" },
        { id: 321725, name: "BGG.CON VFM 2023" },
        { id: 349103, name: "DTW VFM 2025" },
        { id: 328677, name: "DTW VFM 2024" },
        { id: 308714, name: "DTW VFM 2023" },
        { id: 235851, name: "Denver CO VFM" }
    ];
    
    const gamesCardWrapper = document.getElementById('gamesCardWrapper');
    const userDetailsCache = new Map();
    
    let allItems = [];
    let userCollection = new Set();
    let userWantToPlay = new Set();
    let userWantToBuy = new Set();
    let userWantInTrade = new Set();
    let userPrevOwned = new Set();
    let userTradingAway = new Set();
    let loadedCount = 0;
    const PAGE_SIZE = 50;
    let loading = false;
    let currentStatusFilter = '';
    let currentSellerFilter = '';
    let currentFilterMode = 'contains';
    let selectedGeeklists = new Set(geeklists.map(g => g.id));
    const loadMoreWrapper = document.getElementById('loadMoreWrapper');
    const filterInput = document.getElementById('filterInput');

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function formatBGGText(text) {
        if (!text) return text;
        return text
            .replace(/\[B\](.*?)\[\/B\]/gi, '<b>$1</b>')
            .replace(/\[I\](.*?)\[\/I\]/gi, '<i>$1</i>')
            .replace(/\[U\](.*?)\[\/U\]/gi, '<u>$1</u>')
            .replace(/\[size=(\d+)\](.*?)\[\/size\]/gi, '<span style="font-size:$1pt">$2</span>')
            .replace(/\[url=(.*?)\](.*?)\[\/url\]/gi, '<a href="$1" target="_blank" style="color:#1976d2;">$2</a>')
            .replace(/\[thing=(\d+)\](.*?)\[\/thing\]/gi, '<a href="https://boardgamegeek.com/boardgame/$1" target="_blank" style="color:#1976d2;">$2</a>')
            .replace(/\[imageid=(\d+)\]/gi, '<a href="https://boardgamegeek.com/image/$1" target="_blank" style="color:#ff9800;">[View Image $1]</a>')
            .replace(/\n/g, '<br>');
    }
    
    async function fetchUserDetails(username) {
        if (!username) return { name: '', username: '', location: '' };
        if (userDetailsCache.has(username)) {
            return userDetailsCache.get(username);
        }
        
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/user?name=${username}`);
            if (!resp.ok) {
                const result = { name: '', username: username, location: '' };
                userDetailsCache.set(username, result);
                return result;
            }
            
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            
            const firstName = doc.querySelector('firstname')?.getAttribute('value') || '';
            const lastName = doc.querySelector('lastname')?.getAttribute('value') || '';
            const state = doc.querySelector('stateorprovince')?.getAttribute('value') || '';
            const country = doc.querySelector('country')?.getAttribute('value') || '';
            
            const fullName = [firstName, lastName].filter(n => n).join(' ').trim();
            let location = '';
            
            if (state && country) {
                location = `${state}, ${country}`;
            } else if (state) {
                location = state;
            } else if (country) {
                location = country;
            }
            
            const result = {
                name: fullName,
                username: username,
                location: location
            };
            
            userDetailsCache.set(username, result);
            await sleep(500);
            return result;
        } catch (error) {
            const result = { name: '', username: username, location: '' };
            userDetailsCache.set(username, result);
            return result;
        }
    }
    
    async function fetchThingDetails(objectId) {
        if (!objectId) return {};
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${objectId}&stats=1`);
            if (!resp.ok) return {};
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const thumb = doc.querySelector('thumbnail');
            const year = doc.querySelector('yearpublished');
            
            const ranks = doc.querySelectorAll('rank');
            let bggRank = '';
            for (const rank of ranks) {
                if (rank.getAttribute('name') === 'boardgame') {
                    const rankValue = rank.getAttribute('value');
                    bggRank = rankValue && rankValue !== 'Not Ranked' ? rankValue : '';
                    break;
                }
            }
            
            const bayesAverage = doc.querySelector('bayesaverage');
            const bayesValue = bayesAverage ? parseFloat(bayesAverage.getAttribute('value')).toFixed(2) : '';
            
            await sleep(500);
            
            return {
                thumbnail: thumb ? thumb.textContent : '',
                year: year ? year.textContent : '',
                bggRank: bggRank,
                bayesAverage: bayesValue
            };
        } catch {
            return {};
        }
    }

    function getRankGradientColor(rank) {
        if (!rank || rank === 'Not Ranked') return { bg: 'rgba(128,128,128,0.9)', text: 'white' };
        const rankNum = parseInt(rank);
        if (rankNum <= 100) return { bg: 'rgba(76,175,80,0.9)', text: 'white' };
        if (rankNum <= 500) return { bg: 'rgba(139,195,74,0.9)', text: 'white' };
        if (rankNum <= 1000) return { bg: 'rgba(255,235,59,0.9)', text: 'black' };
        if (rankNum <= 5000) return { bg: 'rgba(255,152,0,0.9)', text: 'white' };
        return { bg: 'rgba(244,67,54,0.9)', text: 'white' };
    }

    function getBayesGradientColor(bayes) {
        if (!bayes) return { bg: 'rgba(128,128,128,0.9)', text: 'white' };
        const bayesNum = parseFloat(bayes);
        if (bayesNum >= 8.0) return { bg: 'rgba(76,175,80,0.9)', text: 'white' };
        if (bayesNum >= 7.5) return { bg: 'rgba(139,195,74,0.9)', text: 'white' };
        if (bayesNum >= 7.0) return { bg: 'rgba(255,235,59,0.9)', text: 'black' };
        if (bayesNum >= 6.0) return { bg: 'rgba(255,152,0,0.9)', text: 'white' };
        return { bg: 'rgba(244,67,54,0.9)', text: 'white' };
    }

    function getTimeGradientColor(diffHours) {
        if (diffHours < 1) return { bg: 'rgba(76,175,80,0.9)', text: 'white' };
        if (diffHours < 6) return { bg: 'rgba(139,195,74,0.9)', text: 'white' };
        if (diffHours < 12) return { bg: 'rgba(255,235,59,0.9)', text: 'black' };
        if (diffHours < 24) return { bg: 'rgba(255,152,0,0.9)', text: 'white' };
        return { bg: 'rgba(233,30,99,0.9)', text: 'white' };
    }

    async function fetchSelectedGeeklists(selectedIds) {
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                
                userCollection = new Set();
                const tempWantToPlay = new Set();
                const tempWantToBuy = new Set();
                const tempWantInTrade = new Set();
                const tempPrevOwned = new Set();
                const tempTradingAway = new Set();
                
                items.forEach(item => {
                    const objectId = item.getAttribute('objectid');
                    const status = item.querySelector('status');
                    
                    if (status) {
                        if (status.getAttribute('own') === '1') userCollection.add(objectId);
                        if (status.getAttribute('wanttoplay') === '1') tempWantToPlay.add(objectId);
                        if (status.getAttribute('wanttobuy') === '1') tempWantToBuy.add(objectId);
                        if (status.getAttribute('wantintrade') === '1') tempWantInTrade.add(objectId);
                        if (status.getAttribute('prevowned') === '1') tempPrevOwned.add(objectId);
                        const fortrade = status.getAttribute('fortrade') || '0';
                        if (parseInt(fortrade) > 0) tempTradingAway.add(objectId);
                    }
                });
                
                userWantToPlay = tempWantToPlay;
                userWantToBuy = tempWantToBuy;
                userWantInTrade = tempWantInTrade;
                userPrevOwned = tempPrevOwned;
                userTradingAway = tempTradingAway;
            }
        } catch (error) {
            console.error('Error fetching collection:', error);
        }
        
        gamesCardWrapper.innerHTML = '<div style="text-align:center; color:#888; font-size:1.1em;" id="loadingStatus">Loading Selected Geeklists...</div>';
        allItems = [];
        loadedCount = 0;
        loading = true;
        
        const loadingStatus = document.getElementById('loadingStatus');
        const selectedGeeklistsToLoad = geeklists.filter(g => selectedIds.includes(g.id));
        
        const RETRY_DELAYS = [2000, 4000, 8000];
        const MAX_RETRIES = 3;
        
        for (let g = 0; g < selectedGeeklistsToLoad.length; g++) {
            const geeklist = selectedGeeklistsToLoad[g];
            loadingStatus.innerHTML = `Loading ${geeklist.name}... (${g + 1}/${selectedGeeklistsToLoad.length})`;
            
            let retryCount = 0;
            let success = false;
            
            while (retryCount < MAX_RETRIES && !success) {
                try {
                    const resp = await fetch(`https://boardgamegeek.com/xmlapi/geeklist/${geeklist.id}?comments=1`);
                    
                    const statusInfo = {
                        200: '✅ OK',
                        202: '⏳ Processing',
                        300: '🔄 Redirect',
                        400: '❌ Bad Request',
                        404: '❓ Not Found',
                        429: '⏸️ Rate Limited',
                        500: '💥 Server Error',
                        503: '🔧 Unavailable'
                    };
                    
                    const statusMsg = statusInfo[resp.status] || `Status ${resp.status}`;
                    loadingStatus.innerHTML = `${geeklist.name}: ${statusMsg} (${g + 1}/${selectedGeeklistsToLoad.length})`;
                    
                    if (resp.status === 202) {
                        const delay = RETRY_DELAYS[retryCount];
                        loadingStatus.innerHTML = `${geeklist.name}: Waiting ${delay/1000}s... (${retryCount + 1}/${MAX_RETRIES})`;
                        retryCount++;
                        if (retryCount < MAX_RETRIES) {
                            await sleep(delay);
                            continue;
                        } else {
                            loadingStatus.innerHTML = `${geeklist.name}: Timeout, skipping...`;
                            await sleep(1000);
                            break;
                        }
                    }
                    
                    if (!resp.ok) {
                        loadingStatus.innerHTML = `${geeklist.name}: Error, skipping...`;
                        await sleep(1000);
                        break;
                    }
                    
                    const xml = await resp.text();
                    
                    if (xml.length < 100) {
                        loadingStatus.innerHTML = `${geeklist.name}: Empty, retrying... (${retryCount + 1}/${MAX_RETRIES})`;
                        retryCount++;
                        if (retryCount < MAX_RETRIES) {
                            await sleep(RETRY_DELAYS[retryCount - 1]);
                            continue;
                        } else {
                            loadingStatus.innerHTML = `${geeklist.name}: Failed, skipping...`;
                            await sleep(1000);
                            break;
                        }
                    }
                    
                    const parser = new window.DOMParser();
                    const doc = parser.parseFromString(xml, 'text/xml');
                    
                    const parseError = doc.querySelector('parsererror');
                    if (parseError) {
                        loadingStatus.innerHTML = `${geeklist.name}: Parse error, retrying... (${retryCount + 1}/${MAX_RETRIES})`;
                        retryCount++;
                        if (retryCount < MAX_RETRIES) {
                            await sleep(RETRY_DELAYS[retryCount - 1]);
                            continue;
                        } else {
                            loadingStatus.innerHTML = `${geeklist.name}: Parse failed, skipping...`;
                            await sleep(1000);
                            break;
                        }
                    }
                    
                    const items = Array.from(doc.querySelectorAll('item'));
                    loadingStatus.innerHTML = `${geeklist.name}: ✅ Loaded ${items.length} items`;
                    
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        const commentNodes = Array.from(item.querySelectorAll('comment'));
                        const commentData = commentNodes.map(comment => ({
                            username: comment.getAttribute('username') || '',
                            date: comment.getAttribute('date') || '',
                            content: comment.textContent.trim() || ''
                        }));
                        
                        const username = item.getAttribute('username') || '';
                        
                        const itemData = {
                            geeklistName: geeklist.name,
                            geeklistId: geeklist.id,
                            itemIndex: i + 1,
                            name: item.getAttribute('objectname') || 'Unknown',
                            objectType: item.getAttribute('objecttype') || '',
                            objectId: item.getAttribute('objectid') || '',
                            postdate: item.getAttribute('postdate') || '',
                            comments: item.getAttribute('comments') || '',
                            commentData: commentData,
                            username: username,
                            userDetails: null,
                            details: null,
                            item
                        };
                        
                        allItems.push(itemData);
                        
                        if (username) {
                            fetchUserDetails(username).then(userDetails => {
                                itemData.userDetails = userDetails;
                            });
                        }
                    }
                    
                    allItems.sort((a, b) => {
                        const da = new Date(a.postdate);
                        const db = new Date(b.postdate);
                        return db - da;
                    });
                    
                    renderItems();
                    
                    success = true;
                    await sleep(2000);
                } catch (e) {
                    console.error(`Error fetching ${geeklist.name}:`, e);
                    retryCount++;
                    if (retryCount < MAX_RETRIES) {
                        await sleep(RETRY_DELAYS[retryCount - 1]);
                    }
                }
            }
        }
        
        loading = false;
        selectedGeeklists = new Set(selectedIds);
        updateSellerSuggestions();
        
        const finalLoadingStatus = document.getElementById('loadingStatus');
        if (finalLoadingStatus) {
            finalLoadingStatus.remove();
        }
        
        populateApiAccessPanel(selectedGeeklistsToLoad);
        document.getElementById('apiAccessBtn').style.display = 'block';
        renderItems();
    }

    function updateSellerSuggestions(searchTerm = '') {
        const sellers = new Set();
        allItems.forEach(item => {
            const seller = item.item.getAttribute('username');
            if (seller && seller.trim()) {
                sellers.add(seller.trim());
            }
        });
        
        const filteredSellers = Array.from(sellers)
            .filter(seller => searchTerm === '' || seller.toLowerCase().includes(searchTerm.toLowerCase()))
            .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        
        return filteredSellers;
    }

    function showSellerSuggestions(searchTerm = '') {
        const suggestionsDiv = document.getElementById('sellerSuggestions');
        const filteredSellers = updateSellerSuggestions(searchTerm);
        
        if (filteredSellers.length === 0 || (searchTerm === '' && filteredSellers.length > 20)) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        const sellersToShow = filteredSellers.slice(0, 10);
        suggestionsDiv.innerHTML = '';
        
        if (currentSellerFilter) {
            const clearOption = document.createElement('div');
            clearOption.style.padding = '0.5em 1em';
            clearOption.style.cursor = 'pointer';
            clearOption.style.borderBottom = '1px solid #eee';
            clearOption.style.fontStyle = 'italic';
            clearOption.style.color = '#666';
            clearOption.textContent = 'Clear seller filter';
            clearOption.onclick = () => {
                document.getElementById('sellerFilterInput').value = '';
                currentSellerFilter = '';
                suggestionsDiv.style.display = 'none';
                loadedCount = 0;
                renderItems(filterInput.value.trim());
            };
            suggestionsDiv.appendChild(clearOption);
        }
        
        sellersToShow.forEach(seller => {
            const option = document.createElement('div');
            option.style.padding = '0.5em 1em';
            option.style.cursor = 'pointer';
            option.style.borderBottom = '1px solid #eee';
            option.textContent = seller;
            
            const count = allItems.filter(item => {
                const itemSeller = item.item.getAttribute('username') || '';
                return itemSeller.trim() === seller;
            }).length;
            
            const countSpan = document.createElement('span');
            countSpan
