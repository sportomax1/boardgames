<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGG Geeklist Viewer - Refactored</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* gray-50 */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        /* Card hover effect */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-shadow:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Hide template by default */
        template { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">BGG Geeklist Viewer</h1>
        <p class="text-lg text-gray-600 mt-2">
            Items from Geeklist: <a href="https://boardgamegeek.com/geeklist/299817" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">299817</a>
        </p>
    </header>

    <div id="status-container" class="text-center p-6 bg-blue-100 border border-blue-300 text-blue-800 rounded-xl mb-8" role="alert" aria-live="polite">
        <svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="status-text">Initializing...</span>
    </div>

    <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>

    <template id="game-card-template">
        <div class="card-shadow bg-white rounded-xl overflow-hidden shadow-lg flex flex-col">
            <div class="p-4 flex items-start border-b border-gray-100 bg-gray-50">
                <img data-template="thumbnail" src="https://placehold.co/64x64/E2E8F0/4A5568?text=Img" class="w-16 h-16 object-cover rounded-md flex-shrink-0 mr-4 border border-gray-200" alt="Game Thumbnail">
                <div class="flex-grow">
                    <h2 data-template="gameName" class="text-xl font-bold text-gray-900 leading-tight">Game Title</h2>
                    <p data-template="price" class="text-lg text-red-600 font-semibold mt-1">N/A</p>
                </div>
            </div>
            <div class="p-4 flex-grow">
                <p class="text-xs text-gray-500 mb-4">
                    Posted by: <a data-template="username" href="#" target="_blank" class="font-medium text-blue-600">username</a>
                </p>
                <div class="space-y-1 text-sm text-gray-700 mb-4">
                    <p><span class="font-semibold text-gray-500 w-24 inline-block">Post Date:</span> <span data-template="postDate"></span></p>
                    <p><span class="font-semibold text-gray-500 w-24 inline-block">Thumbs:</span> <span data-template="thumbs" class="text-green-600 font-bold"></span></p>
                    <p><span class="font-semibold text-gray-500 w-24 inline-block">Comments:</span> <span data-template="comments" class="text-gray-900 font-bold"></span></p>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100">
                    <p class="text-xs font-semibold text-gray-600 uppercase mb-1">Description Snippet:</p>
                    <p data-template="bodyPreview" class="text-sm text-gray-700 whitespace-pre-wrap"></p>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 mt-auto">
                <a data-template="bggLink" href="#" target="_blank" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition duration-150 flex items-center justify-center">
                    View Item on BGG
                    <svg class="w-4 h-4 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-4-7l6-6m-6 6l-6-6"></path></svg>
                </a>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /**
             * Main application module to fetch and display BGG Geeklist data.
             */
            const BggGeeklistApp = {
                // --- Configuration ---
                config: {
                    GEEKLIST_ID: '299817',
                    API_THROTTLE_MS: 1500,
                    MAX_RETRIES: 3,
                    get GEEKLIST_API_URL() {
                        return `https://boardgamegeek.com/xmlapi/geeklist/${this.GEEKLIST_ID}?comments=1`;
                    },
                    get THING_API_BASE_URL() {
                        return 'https://boardgamegeek.com/xmlapi2/thing?stats=0&id=';
                    }
                },

                // --- DOM Element Cache ---
                dom: {
                    statusContainer: document.getElementById('status-container'),
                    statusText: document.getElementById('status-text'),
                    cardsContainer: document.getElementById('cards-container'),
                    cardTemplate: document.getElementById('game-card-template'),
                },

                // --- UI Module ---
                ui: {
                    /**
                     * Updates the status message displayed to the user.
                     * @param {string} message - The text to display.
                     * @param {'loading'|'polling'|'error'|'success'|'info'} state - The type of message.
                     */
                    updateStatus(message, state = 'loading') {
                        const { statusContainer, statusText } = BggGeeklistApp.dom;
                        statusContainer.classList.remove('hidden');
                        statusText.textContent = message;

                        // Reset styles
                        statusContainer.className = 'text-center p-6 rounded-xl mb-8 border';
                        const spinner = statusContainer.querySelector('svg');
                        spinner.style.display = 'none';

                        switch (state) {
                            case 'error':
                                statusContainer.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
                                break;
                            case 'success':
                                statusContainer.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
                                setTimeout(() => statusContainer.classList.add('hidden'), 2000); // Hide after 2s
                                break;
                            case 'polling':
                                spinner.style.display = 'inline';
                                statusContainer.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                                break;
                            default: // 'loading' or 'info'
                                spinner.style.display = 'inline';
                                statusContainer.classList.add('bg-blue-100', 'border-blue-300', 'text-blue-800');
                        }
                    },

                    /**
                     * Renders the game cards to the DOM.
                     * @param {Array<Object>} items - The final list of processed items.
                     */
                    renderCards(items) {
                        const { cardsContainer } = BggGeeklistApp.dom;
                        cardsContainer.innerHTML = ''; // Clear previous content
                        
                        if (items.length === 0) {
                            this.updateStatus('No board game items found in this Geeklist.', 'info');
                            return;
                        }

                        const fragment = document.createDocumentFragment();
                        items.forEach(item => {
                            const card = this.createCardElement(item);
                            fragment.appendChild(card);
                        });

                        cardsContainer.appendChild(fragment);
                    },

                    /**
                     * Creates a single card element from the template.
                     * @param {Object} item - The game item data.
                     * @returns {HTMLElement} The populated card element.
                     */
                    createCardElement(item) {
                        const { cardTemplate } = BggGeeklistApp.dom;
                        const cardClone = cardTemplate.content.cloneNode(true);

                        const selectors = {
                            thumbnail: '[data-template="thumbnail"]',
                            gameName: '[data-template="gameName"]',
                            price: '[data-template="price"]',
                            username: '[data-template="username"]',
                            postDate: '[data-template="postDate"]',
                            thumbs: '[data-template="thumbs"]',
                            comments: '[data-template="comments"]',
                            bodyPreview: '[data-template="bodyPreview"]',
                            bggLink: '[data-template="bggLink"]',
                        };

                        const el = (selector) => cardClone.querySelector(selectors[selector]);

                        el('thumbnail').src = item.thumbnail;
                        el('thumbnail').alt = `${item.gameName} Thumbnail`;
                        el('gameName').textContent = item.gameName;
                        el('price').textContent = item.price;
                        el('username').textContent = item.username;
                        el('username').href = `https://boardgamegeek.com/user/${item.username}`;
                        el('postDate').textContent = new Date(item.postdate).toLocaleDateString();
                        el('thumbs').textContent = item.thumbs;
                        el('comments').textContent = item.numcomments;
                        el('bodyPreview').textContent = item.bodyPreview;
                        el('bggLink').href = `https://boardgamegeek.com/geeklist/${this.config.GEEKLIST_ID}/item/${item.id}`;
                        
                        if (item.price.toLowerCase() === 'sold') {
                            el('price').classList.remove('text-red-600');
                            el('price').classList.add('text-gray-500');
                        }

                        return cardClone.firstElementChild;
                    }
                },

                // --- API Module ---
                api: {
                    /**
                     * Fetches XML from BGG, handling retries and 202 status codes.
                     * @param {string} url - The API endpoint URL.
                     * @param {number} retryCount - The current retry attempt.
                     * @returns {Promise<Document>} The parsed XML document.
                     */
                    async fetchXmlWithRetry(url, retryCount = 0) {
                        const { MAX_RETRIES, API_THROTTLE_MS } = BggGeeklistApp.config;

                        try {
                            if (retryCount > 0) {
                                const waitTime = API_THROTTLE_MS * Math.pow(2, retryCount - 1); // Exponential backoff
                                BggGeeklistApp.ui.updateStatus(`BGG is processing. Retrying in ${waitTime / 1000}s... (Attempt ${retryCount + 1})`, 'polling');
                                await new Promise(resolve => setTimeout(resolve, waitTime));
                            }

                            const response = await fetch(url);
                            if (response.status === 202) {
                                throw new Error('BGG API 202: Data processing, will retry.');
                            }
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }

                            const text = await response.text();
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(text, 'application/xml');

                            if (xmlDoc.getElementsByTagName('parsererror').length > 0 || !xmlDoc.documentElement) {
                                throw new Error('Failed to parse XML response from BGG.');
                            }
                            return xmlDoc;

                        } catch (error) {
                            if (retryCount < MAX_RETRIES) {
                                return this.fetchXmlWithRetry(url, retryCount + 1);
                            }
                            throw new Error(`Failed to fetch from BGG after ${MAX_RETRIES + 1} attempts. Please refresh. Error: ${error.message}`);
                        }
                    }
                },

                // --- Parser & Utilities Module ---
                util: {
                    /**
                     * Strips BBCode and cleans text.
                     * @param {string} text - The raw text with BBCode.
                     * @returns {string} The cleaned text.
                     */
                    stripBBCode(text) {
                        if (!text) return '';
                        let cleaned = text
                            .replace(/\[\/?(b|i|u|s|size|url|img|list|center|color|geeklist|thread|thing).*?\]/gi, '')
                            .replace(/\[\/?-\]/g, '\n')
                            .replace(/(\n\s*){2,}/g, '\n\n')
                            .trim();

                        const textarea = document.createElement('textarea');
                        textarea.innerHTML = cleaned;
                        return textarea.value;
                    },

                    /**
                     * Extracts price or "SOLD" status from text.
                     * @param {string} text - The cleaned item body text.
                     * @returns {string} The formatted price or status.
                     */
                    extractPrice(text) {
                        if (text.toLowerCase().includes('sold')) return 'SOLD';
                        let match = text.match(/(?:BIN:?|price:?)\s*\$(\d+(\.\d{2})?)/i) || text.match(/\$(\d+(\.\d{2})?)/);
                        return match ? `$${match[1]}` : 'N/A';
                    },

                    /**
                     * Parses the Geeklist V1 XML.
                     * @param {Document} xmlDoc - The XML document from the Geeklist API.
                     * @returns {{items: Array<Object>, gameIds: Array<string>}}
                     */
                    parseGeeklistItems(xmlDoc) {
                        const items = [];
                        const gameIds = new Set();
                        for (const node of xmlDoc.getElementsByTagName('item')) {
                            if (node.getAttribute('subtype') !== 'boardgame') continue;

                            const bodyNode = node.getElementsByTagName('body')[0];
                            const itemBody = this.stripBBCode(bodyNode ? bodyNode.textContent : '');

                            const item = {
                                id: node.getAttribute('id'),
                                objectid: node.getAttribute('objectid'),
                                username: node.getAttribute('username'),
                                postdate: node.getAttribute('postdate'),
                                thumbs: parseInt(node.getAttribute('thumbs') || 0),
                                numcomments: parseInt(node.getAttribute('numcomments') || 0),
                                price: this.extractPrice(itemBody),
                                bodyPreview: itemBody.substring(0, 150).trim() + (itemBody.length > 150 ? '...' : ''),
                            };
                            items.push(item);
                            gameIds.add(item.objectid);
                        }
                        return { items, gameIds: Array.from(gameIds) };
                    },
                    
                    /**
                     * Parses the Thing (game details) XML.
                     * @param {Document} xmlDoc - The XML document from the Thing API.
                     * @returns {Object} A map of game details keyed by game ID.
                     */
                    parseGameDetails(xmlDoc) {
                        const gameMap = {};
                        for (const node of xmlDoc.getElementsByTagName('item')) {
                            const id = node.getAttribute('id');
                            const nameNode = node.querySelector('name[type="primary"]');
                            const thumbnailNode = node.querySelector('thumbnail');
                            gameMap[id] = {
                                name: nameNode ? nameNode.getAttribute('value') : 'Unknown Game',
                                thumbnail: thumbnailNode ? thumbnailNode.textContent : 'https://placehold.co/100x100?text=No+Img',
                            };
                        }
                        return gameMap;
                    }
                },

                /**
                 * Main application entry point.
                 */
                async init() {
                    try {
                        // 1. Fetch and parse Geeklist
                        this.ui.updateStatus('Fetching Geeklist data...');
                        const geeklistXml = await this.api.fetchXmlWithRetry(this.config.GEEKLIST_API_URL);
                        const { items, gameIds } = this.util.parseGeeklistItems(geeklistXml);

                        if (gameIds.length === 0) {
                            this.ui.updateStatus('No board games found in the list.', 'info');
                            return;
                        }

                        this.ui.updateStatus(`Found ${items.length} games. Fetching details...`);
                        await new Promise(resolve => setTimeout(resolve, this.config.API_THROTTLE_MS));

                        // 2. Fetch and parse Thing details
                        const thingApiUrl = this.config.THING_API_BASE_URL + gameIds.join(',');
                        const thingXml = await this.api.fetchXmlWithRetry(thingApiUrl);
                        const gameDetailsMap = this.util.parseGameDetails(thingXml);

                        // 3. Merge data
                        const finalItems = items.map(item => ({
                            ...item,
                            gameName: gameDetailsMap[item.objectid]?.name || 'Unknown',
                            thumbnail: gameDetailsMap[item.objectid]?.thumbnail || 'https://placehold.co/100x100?text=No+Img'
                        })).sort((a, b) => new Date(b.postdate) - new Date(a.postdate));

                        // 4. Render
                        this.ui.renderCards(finalItems);
                        this.ui.updateStatus(`Successfully loaded ${finalItems.length} items!`, 'success');

                    } catch (error) {
                        console.error('An error occurred during initialization:', error);
                        this.ui.updateStatus(error.message, 'error');
                    }
                }
            };

            // Start the application
            BggGeeklistApp.init();
        });
    </script>
</body>
</html>
