<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VFM Geeklist Analyzer</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General Setup */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        /* Header & Stats */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #1d1d1f;
            margin-bottom: 8px;
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 14px;
            color: #6e6e73;
            margin-bottom: 16px;
        }

        /* Collapsible Section Styles */
        .vfm-controls {
            margin-bottom: 16px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }

        .vfm-controls-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .vfm-controls-header h3 {
            font-size: 16px;
            color: #1d1d1f;
        }

        .vfm-controls-header i {
            transition: transform 0.3s;
        }
        
        .vfm-controls-content {
            max-height: 500px; /* Max height for open state */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            padding-top: 12px; /* Default padding when open */
            
        }

        .vfm-controls-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .vfm-controls-header[aria-expanded="false"] i {
             transform: rotate(-90deg);
        }

        /* Filter Controls within vfm-controls-content */
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .control-group label {
            width: 150px;
            font-size: 14px;
            color: #333;
        }

        .control-group input[type="text"],
        .control-group select {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .control-group input[type="text"]:focus,
        .control-group select:focus {
            border-color: #007aff;
        }

        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            background: #007aff;
            color: white;
            white-space: nowrap;
        }
        
        .action-button:hover {
            background: #005bb5;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        /* Game Card Display */
        #gameCards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .game-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .game-card a {
            text-decoration: none;
            color: inherit;
        }

        .game-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer; /* Image is now the link */
        }
        
        .game-card-content {
            padding: 12px 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .game-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .geeklist-name {
            font-size: 12px;
            color: #8e8e93;
            font-weight: 500;
            line-height: 28px; /* Match listing button height */
        }

        .listing-button {
            background: #ef5350; /* Red color for listing */
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            height: 28px;
            line-height: 1.5;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .listing-button:hover {
            background: #c62828;
        }
        
        .game-title {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
        }
        
        .game-metadata {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #6e6e73;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        
        .game-metadata div {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .game-comments-info {
            color: #6e6e73;
            font-weight: 500;
        }
        
        /* Loading & No Results */
        #loading {
            text-align: center;
            padding: 20px;
            color: #6e6e73;
            font-size: 16px;
        }

        /* Modal for Details */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
        }
        
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #gameCards {
                grid-template-columns: 1fr;
            }
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            .control-group label {
                width: auto;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>VFM Geeklist Analyzer</h1>
        <div class="stats" id="appStats">
            <!-- Stats inserted by JS -->
        </div>
    </div>

    <!-- Collection Filter Section (Now Collapsible) -->
    <div class="vfm-controls" id="vfmControls">
        <div class="vfm-controls-header" id="collectionFilterToggle" aria-expanded="false">
            <h3>Collection Filter <i class="fas fa-chevron-down"></i></h3>
        </div>
        <div id="collectionFilterContent" class="vfm-controls-content collapsed">
            <!-- Collection Search -->
            <div class="control-group">
                <label for="collectionUsernameInput">Collection Username:</label>
                <input type="text" id="collectionUsernameInput" placeholder="Enter BGG Username">
                <button class="action-button" onclick="loadCollectionData()">Load Collection</button>
            </div>
            <div class="control-group">
                <label for="collectionStatus">Collection Status Filter:</label>
                <select id="collectionStatus" onchange="applyFilter()">
                    <option value="">All Items</option>
                    <option value="owned">Owned</option>
                    <option value="wanttobuy">Want To Buy</option>
                    <option value="wishlist">Wishlist</option>
                    <option value="notowned">Not Owned</option>
                </select>
            </div>
            <div class="control-group">
                <label for="vfmStatus">VFM Status Filter:</label>
                <select id="vfmStatus" onchange="applyFilter()">
                    <option value="">All VFM Items</option>
                    <option value="available">Available</option>
                    <option value="sold">Sold</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="filter-buttons">
                <button class="action-button" onclick="resetCollectionFilter()">Reset Collection</button>
            </div>
        </div>
    </div>
    
    <!-- General Filters -->
    <div class="vfm-controls">
        <div class="control-group">
            <label for="gameSearchInput">Search Game Name:</label>
            <input type="text" id="gameSearchInput" placeholder="Type to filter games">
        </div>
        <div class="control-group">
            <label for="userSearchInput">Search User Name:</label>
            <input type="text" id="userSearchInput" placeholder="Type to filter users">
        </div>
        <div class="filter-buttons">
            <button class="action-button" onclick="applyFilter()">Apply Filters</button>
            <button class="action-button" onclick="resetFilter()">Clear All</button>
        </div>
    </div>

    <div id="loading">Loading GeekList data...</div>
    <div id="gameCards">
        <!-- Game cards inserted here -->
    </div>
    
    <div id="noResults" style="text-align: center; padding: 20px; color: #6e6e73; display: none;">No games match your current filters.</div>

    <!-- Modal for Detailed Listing Info -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                <!-- Listing details inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables (mocked/assumed from original file context)
        // These would typically be populated via Firebase or an API call in a real app.
        let baseItems = [];
        let items = [];
        let displayedItems = [];
        let activeCollectionData = {};
        let activeVFMFiles = new Set();
        let currentLoadCount = 0;
        const LOAD_BATCH_SIZE = 20;

        // Mock data for the new status panel, based on request
        const totalVFMFiles = 3; 
        const allVFMFileStats = {
            'BGG VFM 2025': {
                last_file_date: '2025-10-23 09:15:00',
                records_total: 1250,
                records_last_hour: 15,
                records_last_day: 85,
                records_last_7_days: 350,
                records_last_month: 1250
            },
            'Other File': { /* ... */ }
        };

        // --- Core Functions ---

        /**
         * Toggles the visibility of the VFM File Status content.
         */
        function toggleVfmStatus() {
            const toggleElement = document.getElementById('vfmFileStatusToggle');
            const content = document.getElementById('vfmFileStatusContent');
            const icon = toggleElement.querySelector('i');
            
            const isCollapsed = content.classList.toggle('collapsed');
            
            toggleElement.setAttribute('aria-expanded', !isCollapsed);
            icon.classList.toggle('fa-chevron-up', !isCollapsed);
            icon.classList.toggle('fa-chevron-down', isCollapsed);
        }

        /**
         * Toggles the visibility of the Collection Filter content.
         */
        function toggleCollectionFilter() {
            const toggleElement = document.getElementById('collectionFilterToggle');
            const content = document.getElementById('collectionFilterContent');
            const icon = toggleElement.querySelector('i');
            
            const isCollapsed = content.classList.toggle('collapsed');
            
            toggleElement.setAttribute('aria-expanded', !isCollapsed);
            icon.classList.toggle('fa-chevron-up', !isCollapsed);
            icon.classList.toggle('fa-chevron-down', isCollapsed);
        }

        /**
         * Updates the display of statistics in the header.
         * Includes the newly requested list count and VFM status line.
         */
        function updateStats() {
            const totalItems = baseItems.length;
            const currentItems = items.length;
            
            // Stats for list loading
            const listCount = Object.keys(allVFMFileStats).length;
            const totalLists = totalVFMFiles;

            // Stats for BGG VFM 2025 details
            const vfmDetails = allVFMFileStats['BGG VFM 2025'];
            let lastFileDate = 'N/A';
            let recordsTotal = 0;
            let recordsLastHour = 0;
            let recordsLastDay = 0;
            let recordsLast7Days = 0;
            let recordsLastMonth = 0;

            if (vfmDetails) {
                lastFileDate = vfmDetails.last_file_date || 'N/A';
                recordsTotal = vfmDetails.records_total || 0;
                recordsLastHour = vfmDetails.records_last_hour || 0;
                recordsLastDay = vfmDetails.records_last_day || 0;
                recordsLast7Days = vfmDetails.records_last_7_days || 0;
                recordsLastMonth = vfmDetails.records_last_month || 0;
            }

            // Build the VFM Status line (now collapsible)
            const vfmStatusHtml = `
                <div id="vfmFileStatusToggle" class="vfm-controls-header" aria-expanded="false" style="padding: 0; margin-top: 8px;">
                    <h3 style="font-size: 14px; font-weight: 500;">VFM File Status <i class="fas fa-chevron-down"></i></h3>
                </div>
                <div id="vfmFileStatusContent" class="vfm-status-content collapsed" style="padding-top: 4px;">
                    <p style="font-size: 13px;">
                        BGG VFM 2025 | Last File Date: ${lastFileDate} | LOADED | 
                        ${recordsTotal} records total 
                        (${recordsLastHour} - ${recordsLastDay} - ${recordsLast7Days} - ${recordsLastMonth})
                    </p>
                </div>
            `;

            document.getElementById('appStats').innerHTML = `
                <p>Showing ${currentItems} of ${totalItems} games matching current filters.</p>
                <p>${listCount} of ${totalLists} lists loaded.</p>
                ${vfmStatusHtml}
            `;

            // Attach listener for VFM Status toggle
            document.getElementById('vfmFileStatusToggle').addEventListener('click', toggleVfmStatus);
        }

        /**
         * Creates a single game card element based on the provided item data.
         * Implements card updates: image link, listing button placement, comment emoji.
         */
        function createGameCard(item) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            const sourceFile = item.source_file || 'Unknown List';

            // New: Image is the link to BGG
            const thumbnail = item.image || 'https://placehold.co/300x180/A0A0A0/ffffff?text=No+Image';
            const cardImageLink = `<a href="https://boardgamegeek.com/boardgame/${item.bgg_id}" target="_blank" rel="noopener noreferrer">
                <img class="game-image" src="${thumbnail}" alt="${item.name}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/300x180/A0A0A0/ffffff?text=No+Image';" data-bgg-id="${item.bgg_id}">
            </a>`;

            // New: Listing button moved to the header, same height as geeklist name
            const listLink = `<button class="listing-button" onclick="showGameDetail('${item.bgg_id}', '${item.listing_id}')">
                <i class="fas fa-list"></i> Listing
            </button>`;

            const header = `<div class="game-card-header">
                <div class="geeklist-name">${sourceFile}</div>
                ${listLink}
            </div>`;

            const title = `<div class="game-title">${item.name || 'Untitled Game'}</div>`;

            // New: Comment count with emoji
            const commentHtml = item.num_comments > 0 
                ? `<div class="game-comments-info">💬 ${item.num_comments}</div>` 
                : '';
                
            const metadata = `<div class="game-metadata">
                <div><i class="fas fa-user"></i> ${item.listing_user || 'Unknown'}</div>
                ${commentHtml}
            </div>`;

            const content = `<div class="game-card-content">
                <div>
                    ${header}
                    ${title}
                </div>
                ${metadata}
            </div>`;

            card.innerHTML = cardImageLink + content;
            return card;
        }

        /**
         * Renders the visible items to the DOM.
         */
        function renderItems() {
            const container = document.getElementById('gameCards');
            container.innerHTML = '';
            
            if (items.length === 0) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
                updateStats();
                return;
            }

            document.getElementById('noResults').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            
            displayedItems = items.slice(0, currentLoadCount);

            const fragment = document.createDocumentFragment();
            displayedItems.forEach(item => {
                fragment.appendChild(createGameCard(item));
            });

            container.appendChild(fragment);

            updateStats();
        }

        /**
         * Applies all active filters to the base items.
         */
        function applyFilter() {
            const gameSearchTerm = document.getElementById('gameSearchInput').value.toLowerCase();
            const userSearchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const collectionStatus = document.getElementById('collectionStatus').value;
            const vfmStatus = document.getElementById('vfmStatus').value;

            const filteredItems = baseItems.filter(item => {
                const nameMatch = item.name.toLowerCase().includes(gameSearchTerm);
                const userMatch = (item.listing_user || '').toLowerCase().includes(userSearchTerm);
                
                // Collection Status Filter
                let collectionMatch = true;
                if (collectionStatus === 'owned') {
                    collectionMatch = activeCollectionData[item.bgg_id] === 'owned';
                } else if (collectionStatus === 'wanttobuy') {
                    collectionMatch = activeCollectionData[item.bgg_id] === 'wanttobuy';
                } else if (collectionStatus === 'wishlist') {
                    collectionMatch = activeCollectionData[item.bgg_id] === 'wishlist';
                } else if (collectionStatus === 'notowned') {
                    collectionMatch = activeCollectionData[item.bgg_id] !== 'owned';
                }
                
                // VFM Status Filter
                let vfmMatch = true;
                if (vfmStatus === 'available') {
                    vfmMatch = (item.vfm_status || 'available') === 'available';
                } else if (vfmStatus === 'sold') {
                    vfmMatch = item.vfm_status === 'sold';
                } else if (vfmStatus === 'pending') {
                    vfmMatch = item.vfm_status === 'pending';
                }

                // VFM File Filter (based on which list files are "active")
                const sourceFile = item.source_file;
                const fileMatch = activeVFMFiles.size === 0 || activeVFMFiles.has(sourceFile);

                return nameMatch && userMatch && collectionMatch && vfmMatch && fileMatch;
            });

            items = filteredItems;
            currentLoadCount = LOAD_BATCH_SIZE; 
            renderItems();
        }

        /**
         * Resets general filters (game and user search).
         */
        function resetFilter() {
            document.getElementById('gameSearchInput').value = '';
            document.getElementById('userSearchInput').value = '';
            applyFilter();
        }

        /**
         * Resets collection filters.
         */
        function resetCollectionFilter() {
            document.getElementById('collectionUsernameInput').value = '';
            document.getElementById('collectionStatus').value = '';
            activeCollectionData = {};
            applyFilter();
        }

        /**
         * Loads more items when scrolling to the bottom.
         */
        function loadMoreItems() {
            currentLoadCount += LOAD_BATCH_SIZE;
            renderItems();
            loadVisibleThumbnails();
            loadVisibleUsers();
        }
        
        /**
         * Checks if the user has scrolled near the bottom and loads more items if needed.
         */
        function handleScroll() {
            const tolerance = 500;
            if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - tolerance)) {
                if (displayedItems.length < items.length) {
                    loadMoreItems();
                }
            }
            
            loadVisibleThumbnails();
            loadVisibleUsers();
        }

        // --- Mock Data & Setup ---

        /**
         * Mock function to simulate loading all items.
         */
        function loadGeekList() {
            console.log('Fetching GeekList data...');
            // Mock data structure
            baseItems = [
                { bgg_id: '174430', name: 'Gloomhaven', listing_id: '1', listing_user: 'Alice', source_file: 'BGG VFM 2025', num_comments: 5, image: 'https://cf.geekdo-images.com/micro/img/hL-3y4j6f7r3o6f8g6c0v9k4/pic2437871.jpg', vfm_status: 'available' },
                { bgg_id: '161937', name: 'Pandemic Legacy: Season 1', listing_id: '2', listing_user: 'Bob', source_file: 'Other File', num_comments: 1, image: 'https://cf.geekdo-images.com/micro/img/r7S4fW5lM8g7eT9s7p6v2u1j/pic2451000.jpg', vfm_status: 'sold' },
                { bgg_id: '233078', name: 'Twilight Imperium: Fourth Edition', listing_id: '3', listing_user: 'Charlie', source_file: 'BGG VFM 2025', num_comments: 12, image: 'https://cf.geekdo-images.com/micro/img/t6j5j5p0b6n4h8d0y4c7x0z2/pic3014138.jpg', vfm_status: 'pending' },
                { bgg_id: '182046', name: 'Terraforming Mars', listing_id: '4', listing_user: 'Alice', source_file: 'BGG VFM 2025', num_comments: 0, image: 'https://cf.geekdo-images.com/micro/img/b3P9T2l-4k1k-4h8d0y4c7x0z2/pic2891295.jpg', vfm_status: 'available' },
                { bgg_id: '224726', name: 'Root', listing_id: '5', listing_user: 'Eve', source_file: 'BGG VFM 2025', num_comments: 3, image: 'https://cf.geekdo-images.com/micro/img/z5V4h7g6eT9s7p6v2u1j/pic4143243.jpg', vfm_status: 'available' },
                { bgg_id: '28023', name: 'Dixit', listing_id: '6', listing_user: 'Frank', source_file: 'Other File', num_comments: 0, image: 'https://cf.geekdo-images.com/micro/img/j4X5l8g3eT9s7p6v2u1j/pic5689108.jpg', vfm_status: 'available' },
                { bgg_id: '187647', name: 'Scythe', listing_id: '7', listing_user: 'Grace', source_file: 'BGG VFM 2025', num_comments: 7, image: 'https://cf.geekdo-images.com/micro/img/p9Y3g2d-7c6v1k4f5q0m8r2/pic3492716.jpg', vfm_status: 'sold' },
                { bgg_id: '205637', name: 'Arkham Horror: The Card Game', listing_id: '8', listing_user: 'Heidi', source_file: 'BGG VFM 2025', num_comments: 2, image: 'https://cf.geekdo-images.com/micro/img/x8Z2e7f4c5q0m8r2/pic4710126.jpg', vfm_status: 'available' },
                { bgg_id: '96767', name: 'Android: Netrunner', listing_id: '9', listing_user: 'Ian', source_file: 'BGG VFM 2025', num_comments: 0, image: 'https://cf.geekdo-images.com/micro/img/h7J0d1e3a2b4o9q7p1w5x6y/pic1406834.jpg', vfm_status: 'available' },
                { bgg_id: '266395', name: 'Wingspan', listing_id: '10', listing_user: 'Jane', source_file: 'Other File', num_comments: 4, image: 'https://cf.geekdo-images.com/micro/img/a6F9d8c7b6v5u4t3s2r1q0p/pic4458123.jpg', vfm_status: 'pending' },
                // Add more items to enable scrolling and loadMoreItems functionality
                ...Array(15).fill(null).map((_, i) => ({ 
                    bgg_id: String(i + 11), 
                    name: `Mock Game ${i + 11}`, 
                    listing_id: String(i + 11), 
                    listing_user: `MockUser${(i % 5) + 1}`, 
                    source_file: (i % 2 === 0 ? 'BGG VFM 2025' : 'Other File'), 
                    num_comments: i % 3, 
                    vfm_status: i % 4 === 0 ? 'available' : (i % 4 === 1 ? 'sold' : 'pending'),
                    image: `https://placehold.co/300x180/28a745/ffffff?text=Mock+${i+11}`
                }))
            ];

            items = baseItems;
            currentLoadCount = LOAD_BATCH_SIZE;
            renderItems();
        }

        /**
         * Mock function to simulate loading collection data.
         */
        function loadCollectionData() {
            const username = document.getElementById('collectionUsernameInput').value.trim();
            if (!username) {
                alert('Please enter a BGG username.');
                return;
            }
            
            // Mocking a successful load
            console.log(`Loading collection for: ${username}`);
            activeCollectionData = {};
            if (username === 'testuser') {
                activeCollectionData['174430'] = 'owned';
                activeCollectionData['233078'] = 'wanttobuy';
                activeCollectionData['224726'] = 'wishlist';
            } else {
                // Mock a different collection
                activeCollectionData['161937'] = 'owned';
                activeCollectionData['182046'] = 'wishlist';
            }
            
            alert(`Collection for ${username} loaded (Mocked). Applying filter.`);
            applyFilter();
        }

        /**
         * Mock function to show listing details in a modal.
         */
        function showGameDetail(bggId, listingId) {
            const item = baseItems.find(i => i.bgg_id === bggId && i.listing_id === listingId);
            if (!item) return;

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h2>${item.name}</h2>
                <p><strong>Listing ID:</strong> ${item.listing_id}</p>
                <p><strong>User:</strong> ${item.listing_user}</p>
                <p><strong>Comments:</strong> ${item.num_comments}</p>
                <p><strong>Status:</strong> ${item.vfm_status || 'available'}</p>
                <p>This is a mock detail view. In a real app, this would fetch the full listing text.</p>
            `;
            document.getElementById('modal').style.display = 'block';
        }

        /**
         * Closes the modal.
         */
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // --- Utility (Mock for visibility) ---

        function loadVisibleThumbnails() { /* Mock function */ }
        function loadVisibleUsers() { /* Mock function */ }


        // --- Event Listeners and Initial Load ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Collapse Handlers
            document.getElementById('collectionFilterToggle').addEventListener('click', toggleCollectionFilter);
            
            // Initial state for Collection Filter (collapsed by default)
            document.getElementById('collectionFilterContent').classList.add('collapsed');
            document.getElementById('collectionFilterToggle').setAttribute('aria-expanded', 'false');

            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('userSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilter();
                }
            });
            
            document.getElementById('gameSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilter();
                }
            });
            
            document.getElementById('collectionUsernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadCollectionData();
                }
            });
            
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                scrollTimeout = setTimeout(handleScroll, 100);
            });
            
            // Initial Data Load
            loadGeekList();
            // setInterval(loadGeekList, 5 * 60 * 1000); // Keep commented for static example
        });

    </script>
</body>
</html>
