<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>BGG Collection Viewer</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f7f7fa; color: #222; }
        .container { max-width: 900px; margin: 0 auto; padding: 2em 1em 1em 1em; box-sizing: border-box; min-height: 100vh; }
        h1 { font-size: 1.7em; margin-bottom: 1em; text-align: center; }
        
        .form-container { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 1.5em; margin-bottom: 1.5em; }
        
        .submit-btn { background: #1976d2; color: #fff; border: none; border-radius: 8px; padding: 1em; font-size: 1.1em; font-weight: 600; cursor: pointer; width: 100%; }
        .submit-btn:hover { background: #1565c0; }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .print-btn { background: #4caf50; margin-top: 0.5em; }
        .print-btn:hover { background: #388e3c; }
        
        .loading { text-align: center; color: #888; font-size: 1.1em; margin: 2em 0; }
        .stats { background: #e3f2fd; border-radius: 8px; padding: 1em; margin-bottom: 1em; font-size: 0.95em; }
        .error { background: #ffebee; color: #c62828; border-radius: 8px; padding: 1em; margin: 1em 0; }
        
        .sort-controls { background: #fff; border-radius: 8px; padding: 1em; margin-bottom: 1em; box-shadow: 0 2px 8px #0001; }
        .sort-label { font-weight: 600; margin-right: 0.5em; }
        .sort-select { padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; }
        
        .game-list { margin-top: 1em; }
        .game-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; margin-bottom: 1em; padding: 1em 1.2em; display: flex; flex-direction: row; align-items: center; position: relative; }
        .game-thumb { width: 64px; height: 64px; border-radius: 10px; margin-right: 1em; object-fit: contain; flex-shrink: 0; background: #f5f5f5; }
        .game-info { display: flex; flex-direction: column; flex: 1; }
        .game-title { font-size: 1.1em; font-weight: 600; margin-bottom: 0.2em; }
        .game-details { font-size: 0.98em; color: #555; }
        
        .sort-index { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 0.2em 0.5em; border-radius: 8px; font-size: 0.75em; font-weight: 600; z-index: 3; }
        
        .bayes-indicator { position: absolute; bottom: 8px; right: 8px; padding: 0.2em 0.5em; border-radius: 8px; font-size: 0.75em; font-weight: 600; }
        .bayes-excellent { background: rgba(76,175,80,0.9); color: white; }
        .bayes-very-good { background: rgba(139,195,74,0.9); color: white; }
        .bayes-good { background: rgba(255,235,59,0.9); color: black; }
        .bayes-average { background: rgba(255,152,0,0.9); color: white; }
        .bayes-below { background: rgba(244,67,54,0.9); color: white; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 1.5em; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 1.2em; font-weight: 600; margin-bottom: 1em; text-align: center; }
        .corner-options { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8em; margin-bottom: 1em; }
        .corner-group { border: 1px solid #ddd; border-radius: 8px; padding: 0.8em; }
        .corner-title { font-weight: 600; margin-bottom: 0.5em; font-size: 0.85em; }
        .option-group { margin-bottom: 0.5em; }
        .option-group label { display: block; font-size: 0.8em; margin-bottom: 0.3em; }
        .option-group select { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8em; }
        .modal-buttons { display: flex; gap: 0.8em; justify-content: center; margin-top: 1.5em; }
        .modal-btn { padding: 0.8em 1.2em; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9em; }
        .btn-print { background: #4caf50; color: white; }
        .btn-cancel { background: #ccc; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BGG Collection Viewer</h1>
        
        <div class="form-container">
            <button id="loadBtn" class="submit-btn">Load Collection from private_own.xml</button>
            <button id="printBtn" class="submit-btn print-btn" disabled>ðŸ“„ Print View (Top 120)</button>
        </div>
        
        <div id="results"></div>
    </div>

    <!-- Print Options Modal -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Print Layout Options</div>
            
            <div class="corner-options">
                <div class="corner-group">
                    <div class="corner-title">Top Left</div>
                    <div class="option-group">
                        <label>Show:</label>
                        <select id="topLeft">
                            <option value="rank" selected>Rank Number</option>
                            <option value="bayes">Bayes Average</option>
                            <option value="rating">My Rating</option>
                            <option value="numplays">Num Plays</option>
                            <option value="weight">My Weight</option>
                            <option value="avgweight">BGG Avg Weight</option>
                            <option value="average">BGG Average</option>
                            <option value="year">Year</option>
                            <option value="playingtime">Playing Time</option>
                            <option value="minplayers">Min Players</option>
                            <option value="maxplayers">Max Players</option>
                            <option value="players">Players Range</option>
                            <option value="numowned">Num Owned</option>
                            <option value="pricepaid">Price Paid</option>
                            <option value="invlocation">Location</option>
                            <option value="quantity">Quantity</option>
                            <option value="none">Nothing</option>
                        </select>
                    </div>
                </div>
                
                <div class="corner-group">
                    <div class="corner-title">Top Right</div>
                    <div class="option-group">
                        <label>Show:</label>
                        <select id="topRight">
                            <option value="none" selected>Nothing</option>
                            <option value="bayes">Bayes Average</option>
                            <option value="rating">My Rating</option>
                            <option value="numplays">Num Plays</option>
                            <option value="weight">My Weight</option>
                            <option value="avgweight">BGG Avg Weight</option>
                            <option value="average">BGG Average</option>
                            <option value="year">Year</option>
                            <option value="playingtime">Playing Time</option>
                            <option value="minplayers">Min Players</option>
                            <option value="maxplayers">Max Players</option>
                            <option value="players">Players Range</option>
                            <option value="numowned">Num Owned</option>
                            <option value="pricepaid">Price Paid</option>
                            <option value="invlocation">Location</option>
                            <option value="quantity">Quantity</option>
                        </select>
                    </div>
                </div>
                
                <div class="corner-group">
                    <div class="corner-title">Bottom Left</div>
                    <div class="option-group">
                        <label>Show:</label>
                        <select id="bottomLeft">
                            <option value="none" selected>Nothing</option>
                            <option value="bayes">Bayes Average</option>
                            <option value="rating">My Rating</option>
                            <option value="numplays">Num Plays</option>
                            <option value="weight">My Weight</option>
                            <option value="avgweight">BGG Avg Weight</option>
                            <option value="average">BGG Average</option>
                            <option value="year">Year</option>
                            <option value="playingtime">Playing Time</option>
                            <option value="minplayers">Min Players</option>
                            <option value="maxplayers">Max Players</option>
                            <option value="players">Players Range</option>
                            <option value="numowned">Num Owned</option>
                            <option value="pricepaid">Price Paid</option>
                            <option value="invlocation">Location</option>
                            <option value="quantity">Quantity</option>
                        </select>
                    </div>
                </div>
                
                <div class="corner-group">
                    <div class="corner-title">Bottom Right</div>
                    <div class="option-group">
                        <label>Show:</label>
                        <select id="bottomRight">
                            <option value="bayes" selected>Bayes Average</option>
                            <option value="rating">My Rating</option>
                            <option value="numplays">Num Plays</option>
                            <option value="weight">My Weight</option>
                            <option value="avgweight">BGG Avg Weight</option>
                            <option value="average">BGG Average</option>
                            <option value="year">Year</option>
                            <option value="playingtime">Playing Time</option>
                            <option value="minplayers">Min Players</option>
                            <option value="maxplayers">Max Players</option>
                            <option value="players">Players Range</option>
                            <option value="numowned">Num Owned</option>
                            <option value="pricepaid">Price Paid</option>
                            <option value="invlocation">Location</option>
                            <option value="quantity">Quantity</option>
                            <option value="none">Nothing</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closePrintModal()">Cancel</button>
                <button class="modal-btn btn-print" onclick="proceedToPrint()">Generate Print View</button>
            </div>
        </div>
    </div>

    <script>
        let allGames = [];
        let currentSortedGames = [];
        let currentGameDetails = {};

        // Parse XML collection file
        function parseCollectionXML(xmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, 'text/xml');
            const items = Array.from(doc.querySelectorAll('item'));
            
            return items.map(item => {
                const getTextContent = (selector) => item.querySelector(selector)?.textContent || '';
                const getFloat = (selector) => parseFloat(getTextContent(selector)) || 0;
                const getInt = (selector) => parseInt(getTextContent(selector)) || 0;
                
                return {
                    objectId: getTextContent('objectid'),
                    name: getTextContent('objectname'),
                    rating: getFloat('rating'),
                    numPlays: getInt('numplays'),
                    weight: getFloat('weight'),
                    own: getInt('own'),
                    fortrade: getInt('fortrade'),
                    want: getInt('want'),
                    wanttobuy: getInt('wanttobuy'),
                    wanttoplay: getInt('wanttoplay'),
                    prevowned: getInt('prevowned'),
                    preordered: getInt('preordered'),
                    wishlist: getInt('wishlist'),
                    wishlistpriority: getInt('wishlistpriority'),
                    bayesAverage: getFloat('baverage'),
                    average: getFloat('average'),
                    avgWeight: getFloat('avgweight'),
                    rank: getInt('rank'),
                    numOwned: getInt('numowned'),
                    minPlayers: getInt('minplayers'),
                    maxPlayers: getInt('maxplayers'),
                    playingTime: getInt('playingtime'),
                    minPlaytime: getInt('minplaytime'),
                    maxPlaytime: getInt('maxplaytime'),
                    year: getTextContent('yearpublished'),
                    bggRecPlayers: getTextContent('bggrecplayers'),
                    bggBestPlayers: getTextContent('bggbestplayers'),
                    invLocation: getTextContent('invlocation'),
                    pricePaid: getFloat('pricepaid'),
                    acquisitionDate: getTextContent('acquisitiondate'),
                    acquiredFrom: getTextContent('acquiredfrom'),
                    quantity: getInt('quantity'),
                    thumbnail: ''
                };
            });
        }

        // Fetch thumbnails in batches
        async function fetchThumbnails(games, startTime) {
            const resultsDiv = document.getElementById('results');
            const batchSize = 20;
            
            for (let i = 0; i < games.length; i += batchSize) {
                const batch = games.slice(i, i + batchSize);
                const idsParam = batch.map(g => g.objectId).join(',');
                
                const progress = Math.round((i / games.length) * 100);
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                const progressDiv = resultsDiv.querySelector('.progress-info') || document.createElement('div');
                progressDiv.className = 'progress-info';
                progressDiv.style.cssText = 'background:#fff3e0; border-radius:8px; padding:0.8em; margin:0.5em 0; font-size:0.9em; border-left:4px solid #ff9800;';
                progressDiv.innerHTML = `
                    <strong>ðŸ”„ Fetching thumbnails...</strong><br>
                    Progress: ${progress}% (${i}/${games.length})<br>
                    Elapsed: ${elapsedTime}s
                `;
                
                const statsDiv = resultsDiv.querySelector('.stats');
                if (statsDiv && !resultsDiv.querySelector('.progress-info')) {
                    statsDiv.insertAdjacentElement('afterend', progressDiv);
                }
                
                try {
                    const response = await fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${idsParam}&stats=1`);
                    
                    if (response.ok) {
                        const xml = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xml, 'text/xml');
                        
                        const items = Array.from(doc.querySelectorAll('item'));
                        items.forEach(item => {
                            const objectId = item.getAttribute('id');
                            const game = games.find(g => g.objectId === objectId);
                            if (game) {
                                game.thumbnail = item.querySelector('thumbnail')?.textContent || '';
                            }
                        });
                        
                        if (i % (batchSize * 2) === 0 || i + batchSize >= games.length) {
                            updateGameDisplay();
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching batch starting at ${i}:`, error);
                }
                
                if (i + batchSize < games.length) {
                    await new Promise(resolve => setTimeout(resolve, 2500));
                }
            }
            
            const progressDiv = resultsDiv.querySelector('.progress-info');
            if (progressDiv) progressDiv.remove();
        }

        // Sort games based on selected criteria
        function sortGames(games, sortBy) {
            const sorted = [...games];
            
            switch(sortBy) {
                case 'bayes':
                    sorted.sort((a, b) => b.bayesAverage - a.bayesAverage);
                    break;
                case 'rating':
                    sorted.sort((a, b) => b.rating - a.rating);
                    break;
                case 'numplays':
                    sorted.sort((a, b) => b.numPlays - a.numPlays);
                    break;
                case 'weight':
                    sorted.sort((a, b) => b.weight - a.weight);
                    break;
                case 'rank':
                    sorted.sort((a, b) => {
                        if (a.rank === 0) return 1;
                        if (b.rank === 0) return -1;
                        return a.rank - b.rank;
                    });
                    break;
                case 'year':
                    sorted.sort((a, b) => parseInt(b.year) - parseInt(a.year));
                    break;
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'avgweight':
                    sorted.sort((a, b) => b.avgWeight - a.avgWeight);
                    break;
                case 'playingtime':
                    sorted.sort((a, b) => b.playingTime - a.playingTime);
                    break;
                case 'average':
                    sorted.sort((a, b) => b.average - a.average);
                    break;
                case 'numowned':
                    sorted.sort((a, b) => b.numOwned - a.numOwned);
                    break;
                case 'minplayers':
                    sorted.sort((a, b) => a.minPlayers - b.minPlayers);
                    break;
                case 'maxplayers':
                    sorted.sort((a, b) => b.maxPlayers - a.maxPlayers);
                    break;
                case 'pricepaid':
                    sorted.sort((a, b) => b.pricePaid - a.pricePaid);
                    break;
                case 'acquisitiondate':
                    sorted.sort((a, b) => b.acquisitionDate.localeCompare(a.acquisitionDate));
                    break;
                case 'invlocation':
                    sorted.sort((a, b) => a.invLocation.localeCompare(b.invLocation));
                    break;
                case 'quantity':
                    sorted.sort((a, b) => b.quantity - a.quantity);
                    break;
            }
            
            return sorted;
        }

        // Update game display
        function updateGameDisplay() {
            const resultsDiv = document.getElementById('results');
            const sortBy = document.getElementById('sortBy')?.value || 'bayes';
            
            const gameList = resultsDiv.querySelector('.game-list');
            if (!gameList) return;
            
            let html = '';
            currentSortedGames.forEach((game, index) => {
                const bayesClass = getBayesStyle(game.bayesAverage);
                const bayesText = game.bayesAverage > 0 ? game.bayesAverage.toFixed(2) : 'N/A';
                
                html += `
                    <div class="game-card">
                        <div class="sort-index">#${index + 1}</div>
                        <div class="bayes-indicator ${bayesClass}">${bayesText}</div>
                        <img src="${game.thumbnail || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'64\' height=\'64\'%3E%3Crect fill=\'%23f5f5f5\' width=\'64\' height=\'64\'/%3E%3C/svg%3E'}" 
                             alt="${game.name}" class="game-thumb" onerror="this.style.display='none'">
                        <div class="game-info">
                            <div class="game-title">${game.name}</div>
                            <div class="game-details">
                                <strong>Year:</strong> ${game.year} | 
                                <strong>Players:</strong> ${game.minPlayers}-${game.maxPlayers} | 
                                <strong>Time:</strong> ${game.playingTime}min<br>
                                <strong>My Rating:</strong> ${game.rating.toFixed(1)} | 
                                <strong>Plays:</strong> ${game.numPlays} | 
                                <strong>Weight:</strong> ${game.weight.toFixed(1)}<br>
                                ${game.rank ? '<strong>BGG Rank:</strong> #' + game.rank + ' | ' : ''}
                                <strong>Avg:</strong> ${game.average.toFixed(2)} | 
                                <strong>Avg Weight:</strong> ${game.avgWeight.toFixed(2)}<br>
                                ${game.invLocation ? '<strong>Location:</strong> ' + game.invLocation + ' | ' : ''}
                                ${game.pricePaid ? '<strong>Price Paid:</strong> $' + game.pricePaid.toFixed(2) + '<br>' : ''}
                                ${game.acquisitionDate ? '<strong>Acquired:</strong> ' + game.acquisitionDate + (game.acquiredFrom ? ' from ' + game.acquiredFrom : '') + '<br>' : ''}
                                <a href="https://boardgamegeek.com/boardgame/${game.objectId}" target="_blank" style="color:#1976d2;">View on BGG</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            gameList.innerHTML = html;
        }

        // Display results
        function displayResults(games) {
            const resultsDiv = document.getElementById('results');
            
            currentSortedGames = sortGames(games, 'bayes');
            
            let html = `
                <div class="stats">
                    <strong>Collection Loaded:</strong><br>
                    Total games: ${games.length}
                </div>
                
                <div class="sort-controls">
                    <label class="sort-label">Sort by:</label>
                    <select id="sortBy" class="sort-select" onchange="handleSortChange()">
                        <option value="bayes">Bayes Average (BGG Rating)</option>
                        <option value="rating">My Rating</option>
                        <option value="numplays">Number of Plays</option>
                        <option value="weight">My Weight</option>
                        <option value="avgweight">BGG Average Weight</option>
                        <option value="rank">BGG Rank</option>
                        <option value="average">BGG Average Rating</option>
                        <option value="year">Year Published</option>
                        <option value="playingtime">Playing Time</option>
                        <option value="minplayers">Min Players</option>
                        <option value="maxplayers">Max Players</option>
                        <option value="numowned">Number Owned (BGG)</option>
                        <option value="pricepaid">Price Paid</option>
                        <option value="acquisitiondate">Acquisition Date</option>
                        <option value="invlocation">Location</option>
                        <option value="quantity">Quantity</option>
                        <option value="name">Name (A-Z)</option>
                    </select>
                </div>
                
                <div class="game-list"></div>
            `;
            
            resultsDiv.innerHTML = html;
            updateGameDisplay();
            
            document.getElementById('printBtn').disabled = false;
        }

        // Handle sort change
        window.handleSortChange = function() {
            const sortBy = document.getElementById('sortBy').value;
            currentSortedGames = sortGames(currentSortedGames, sortBy);
            updateGameDisplay();
        };

        // Get Bayes style
        function getBayesStyle(bayes) {
            if (bayes >= 8.0) return 'bayes-excellent';
            if (bayes >= 7.5) return 'bayes-very-good';
            if (bayes >= 7.0) return 'bayes-good';
            if (bayes >= 6.0) return 'bayes-average';
            return 'bayes-below';
        }

        // Handle file load from repo
        async function handleFileLoad() {
            const loadBtn = document.getElementById('loadBtn');
            const resultsDiv = document.getElementById('results');
            
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            resultsDiv.innerHTML = '<div class="loading">Fetching private_own.xml from repository...</div>';
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('private_own.xml');
                
                if (!response.ok) {
                    throw new Error(`Failed to load private_own.xml: ${response.status}`);
                }
                
                const xmlText = await response.text();
                allGames = parseCollectionXML(xmlText);
                
                if (allGames.length === 0) {
                    resultsDiv.innerHTML = '<div class="error">No games found in XML file.</div>';
                    return;
                }
                
                displayResults(allGames);
                
                fetchThumbnails(allGames, startTime);
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="error">Error loading file: ${error.message}<br><small>Make sure private_own.xml is in the same directory as this HTML file.</small></div>`;
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Collection from private_own.xml';
            }
        }

        // Print modal functions
        window.showPrintModal = function() {
            if (!currentSortedGames || currentSortedGames.length === 0) {
                alert('No games to print. Please load a collection first.');
                return;
            }
            document.getElementById('printModal').style.display = 'block';
        };

        window.closePrintModal = function() {
            document.getElementById('printModal').style.display = 'none';
        };

        window.proceedToPrint = function() {
            const printOptions = {
                topLeft: document.getElementById('topLeft').value,
                topRight: document.getElementById('topRight').value,
                bottomLeft: document.getElementById('bottomLeft').value,
                bottomRight: document.getElementById('bottomRight').value
            };
            
            createPrintView(printOptions);
            closePrintModal();
        };

        // Create print view
        function createPrintView(printOptions = {}) {
            const options = {
                topLeft: 'rank',
                topRight: 'none',
                bottomLeft: 'none',
                bottomRight: 'bayes',
                ...printOptions
            };
            
            const gamesData = currentSortedGames.slice(0, 120).map(game => ({
                name: game.name,
                thumbnail: game.thumbnail,
                category: 'supported',
                bayesAverage: game.bayesAverage || 0,
                playerVotes: []
            }));
            
            const printData = {
                username: 'Sportomax',
                playerCount: 'All',
                games: gamesData,
                printOptions: options,
                timestamp: Date.now()
            };
            
            localStorage.setItem('bgg_print_data', JSON.stringify(printData));
            
            const baseUrl = window.location.href.replace(/[^\/]*$/, 'private_print.html');
            const printUrl = baseUrl + '?t=' + Date.now();
            
            window.open(printUrl, '_blank');
        }

        // Event listeners
        document.getElementById('loadBtn').addEventListener('click', handleFileLoad);
        document.getElementById('printBtn').addEventListener('click', showPrintModal);
        
        // Clear localStorage on page load
        window.addEventListener('load', () => {
            localStorage.removeItem('bgg_print_data');
        });
    </script>
</body>
</html>
