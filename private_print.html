<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGG Top 120 Print View</title>
    <style>
        @page { 
            size: letter; 
            margin: 0.5in;
            @top-left { content: ""; }
            @top-center { content: ""; }
            @top-right { content: ""; }
            @bottom-left { content: ""; }
            @bottom-center { content: ""; }
            @bottom-right { content: ""; }
        }
        
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 0.25in; 
            font-size: 16px; 
            font-weight: bold; 
            color: #333;
        }
        
        .custom-footer {
            position: fixed;
            bottom: 0.25in;
            right: 0.5in;
            font-size: 10px;
            color: #666;
            z-index: 1000;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            grid-template-rows: repeat(12, 1fr); 
            gap: 2px; 
            width: 7.5in; 
            height: 9in; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
        }
        
        .tile { 
            position: relative; 
            border: 1px solid #ddd; 
            background: #f9f9f9; 
            overflow: hidden;
        }
        
        .tile img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block;
            background: #f5f5f5;
        }
        
        .tile-data { 
            position: absolute; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            font-size: 7px; 
            padding: 1px 2px; 
            border-radius: 2px; 
            font-weight: bold; 
            z-index: 10;
            line-height: 1.2;
        }
        
        .top-left { top: 1px; left: 1px; }
        .top-right { top: 1px; right: 1px; }
        .bottom-left { bottom: 1px; left: 1px; }
        .bottom-right { bottom: 1px; right: 1px; }
        
        .bayes-circle { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 8px; 
            font-weight: bold; 
            color: black; 
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }
        
        .loading {
            text-align: center;
            padding: 2em;
            font-size: 18px;
            color: #666;
        }
        
        @media print {
            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print { display: none !important; }
            
            @page {
                margin: 0.5in;
                size: letter;
                @top-left { content: "" !important; }
                @top-center { content: "" !important; }
                @top-right { content: "" !important; }
                @bottom-left { content: "" !important; }
                @bottom-center { content: "" !important; }
                @bottom-right { content: "" !important; }
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        Loading games data...<br>
        <small style="color:#666; margin-top:1em; display:block; font-size:12px; line-height:1.4;">
            ðŸ’¡ <strong>For clean printing:</strong> In your browser's Print Settings, turn off "Headers and footers" to remove URL, page numbers, and date/time from the printout.
        </small>
    </div>
    
    <div id="printContent" style="display: none;">
        <div class="header" id="header"></div>
        <div class="grid" id="grid"></div>
        <div class="custom-footer" id="customFooter"></div>
    </div>

    <script>
        function getPrintData() {
            try {
                const stored = localStorage.getItem('bgg_print_data');
                if (!stored) {
                    throw new Error('No print data found');
                }
                
                const data = JSON.parse(stored);
                
                const age = Date.now() - data.timestamp;
                if (age > 300000) {
                    throw new Error('Print data expired');
                }
                
                return data;
            } catch (error) {
                console.error('Error getting print data:', error);
                return null;
            }
        }

        function formatValue(game, field) {
            if (!field || field === 'none') return '';
            
            switch(field) {
                case 'rank':
                    return game.rank || '#';
                case 'bayes':
                    return game.bayesAverage ? game.bayesAverage.toFixed(1) : '';
                case 'rating':
                    return game.rating ? game.rating.toFixed(1) : '';
                case 'numplays':
                    return game.numPlays || '0';
                case 'weight':
                    return game.weight ? game.weight.toFixed(1) : '';
                case 'avgweight':
                    return game.avgWeight ? game.avgWeight.toFixed(1) : '';
                case 'average':
                    return game.average ? game.average.toFixed(1) : '';
                case 'year':
                    return game.year || '';
                case 'playingtime':
                    return game.playingTime ? game.playingTime + 'm' : '';
                case 'minplayers':
                    return game.minPlayers || '';
                case 'maxplayers':
                    return game.maxPlayers || '';
                case 'players':
                    return `${game.minPlayers || '?'}-${game.maxPlayers || '?'}`;
                case 'numowned':
                    return game.numOwned || '';
                case 'pricepaid':
                    return game.pricePaid ? '$' + game.pricePaid.toFixed(0) : '';
                case 'invlocation':
                    return game.invLocation || '';
                case 'quantity':
                    return game.quantity || '1';
                default:
                    return '';
            }
        }

        function getBayesColor(bayes) {
            const score = Math.max(0, Math.min(10, bayes));
            let red, green, blue = 0;
            
            if (score < 2) {
                red = 200 + Math.round(55 * (score / 2));
                green = Math.round(20 * (score / 2));
            } else if (score < 4) {
                red = 255;
                green = Math.round(80 * ((score - 2) / 2));
            } else if (score < 5.5) {
                red = 255;
                green = 80 + Math.round(95 * ((score - 4) / 1.5));
            } else if (score < 7) {
                red = 255;
                green = 175 + Math.round(80 * ((score - 5.5) / 1.5));
            } else if (score < 8.5) {
                red = 255 - Math.round(100 * ((score - 7) / 1.5));
                green = 255;
            } else {
                red = 155 - Math.round(155 * ((score - 8.5) / 1.5));
                green = 255;
            }
            
            return `rgb(${red}, ${green}, ${blue})`;
        }

        function initializePrintView() {
            try {
                const printData = getPrintData();
                
                if (!printData) {
                    document.getElementById('loading').innerHTML = 'Error: No valid print data found. Please try again from the main page.';
                    return;
                }
                
                const { username, games, printOptions = {}, sortMode = 'bayes' } = printData;
                
                const options = {
                    topLeft: 'rank',
                    topRight: 'none',
                    bottomLeft: 'none',
                    bottomRight: 'bayes',
                    ...printOptions
                };
                
                const header = document.getElementById('header');
                const sortModeLabels = {
                    'bayes': 'Bayes Average',
                    'rating': 'My Rating',
                    'numplays': 'Number of Plays',
                    'weight': 'My Weight',
                    'avgweight': 'BGG Avg Weight',
                    'rank': 'BGG Rank',
                    'average': 'BGG Average',
                    'year': 'Year',
                    'playingtime': 'Playing Time',
                    'minplayers': 'Min Players',
                    'maxplayers': 'Max Players',
                    'numowned': 'Number Owned',
                    'pricepaid': 'Price Paid',
                    'acquisitiondate': 'Acquisition Date',
                    'invlocation': 'Location',
                    'quantity': 'Quantity',
                    'name': 'Name'
                };
                header.textContent = `${username} - Top 120 Games (Sorted by: ${sortModeLabels[sortMode] || sortMode})`;
                
                const footer = document.getElementById('customFooter');
                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                footer.textContent = `${timestamp}`;
                
                const grid = document.getElementById('grid');
                const top120 = games.slice(0, 120);
                
                for (let i = 0; i < 120; i++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    
                    if (i < top120.length && top120[i]) {
                        const game = top120[i];
                        
                        // Top Left
                        if (options.topLeft !== 'none') {
                            const topLeft = document.createElement('div');
                            topLeft.className = 'tile-data top-left';
                            
                            if (options.topLeft === 'rank') {
                                topLeft.textContent = i + 1;
                            } else if (options.topLeft === 'bayes' && game.bayesAverage > 0) {
                                topLeft.className = 'tile-data top-left bayes-circle';
                                topLeft.style.backgroundColor = getBayesColor(game.bayesAverage);
                                topLeft.textContent = game.bayesAverage.toFixed(1);
                            } else {
                                topLeft.textContent = formatValue(game, options.topLeft);
                            }
                            
                            if (topLeft.textContent) {
                                tile.appendChild(topLeft);
                            }
                        }
                        
                        // Top Right
                        if (options.topRight !== 'none') {
                            const topRight = document.createElement('div');
                            topRight.className = 'tile-data top-right';
                            
                            if (options.topRight === 'bayes' && game.bayesAverage > 0) {
                                topRight.className = 'tile-data top-right bayes-circle';
                                topRight.style.backgroundColor = getBayesColor(game.bayesAverage);
                                topRight.textContent = game.bayesAverage.toFixed(1);
                            } else {
                                topRight.textContent = formatValue(game, options.topRight);
                            }
                            
                            if (topRight.textContent) {
                                tile.appendChild(topRight);
                            }
                        }
                        
                        // Bottom Left
                        if (options.bottomLeft !== 'none') {
                            const bottomLeft = document.createElement('div');
                            bottomLeft.className = 'tile-data bottom-left';
                            
                            if (options.bottomLeft === 'bayes' && game.bayesAverage > 0) {
                                bottomLeft.className = 'tile-data bottom-left bayes-circle';
                                bottomLeft.style.backgroundColor = getBayesColor(game.bayesAverage);
                                bottomLeft.textContent = game.bayesAverage.toFixed(1);
                            } else {
                                bottomLeft.textContent = formatValue(game, options.bottomLeft);
                            }
                            
                            if (bottomLeft.textContent) {
                                tile.appendChild(bottomLeft);
                            }
                        }
                        
                        // Bottom Right
                        if (options.bottomRight !== 'none') {
                            const bottomRight = document.createElement('div');
                            bottomRight.className = 'tile-data bottom-right';
                            
                            if (options.bottomRight === 'bayes' && game.bayesAverage > 0) {
                                bottomRight.className = 'tile-data bottom-right bayes-circle';
                                bottomRight.style.backgroundColor = getBayesColor(game.bayesAverage);
                                bottomRight.textContent = game.bayesAverage.toFixed(1);
                            } else {
                                bottomRight.textContent = formatValue(game, options.bottomRight);
                            }
                            
                            if (bottomRight.textContent) {
                                tile.appendChild(bottomRight);
                            }
                        }
                        
                        // Add game thumbnail
                        if (game.thumbnail) {
                            const img = document.createElement('img');
                            img.src = game.thumbnail;
                            img.alt = game.name || 'Game thumbnail';
                            img.onerror = function() {
                                this.style.display = 'none';
                            };
                            tile.appendChild(img);
                        }
                    }
                    
                    grid.appendChild(tile);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('printContent').style.display = 'block';
                
                setTimeout(() => {
                    window.print();
                }, 1000);
                
            } catch (error) {
                console.error('Error initializing print view:', error);
                document.getElementById('loading').innerHTML = 'Error loading games data. Please try again.';
            }
        }

        window.addEventListener('load', initializePrintView);
    </script>
</body>
</html>
