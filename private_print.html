<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGG Top 120 Print View</title>
    <style>
        @page { 
            size: letter; 
            margin: 0.5in;
            @top-left { content: ""; }
            @top-center { content: ""; }
            @top-right { content: ""; }
            @bottom-left { content: ""; }
            @bottom-center { content: ""; }
            @bottom-right { content: ""; }
        }
        
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 0.25in; 
            font-size: 16px; 
            font-weight: bold; 
            color: #333;
        }
        
        .custom-footer {
            position: fixed;
            bottom: 0.25in;
            right: 0.5in;
            font-size: 10px;
            color: #666;
            z-index: 1000;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            grid-template-rows: repeat(12, 1fr); 
            gap: 2px; 
            width: 7.5in; 
            height: 9in; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
        }
        
        .tile { 
            position: relative; 
            border: 1px solid #ddd; 
            background: #f9f9f9; 
            overflow: hidden;
        }
        
        .tile img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block;
            background: #f5f5f5;
        }
        
        .rank { 
            position: absolute; 
            top: 1px; 
            left: 1px; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            font-size: 8px; 
            padding: 1px 2px; 
            border-radius: 2px; 
            font-weight: bold; 
            z-index: 10;
        }
        
        .category { 
            position: absolute; 
            top: 1px; 
            right: 1px; 
            font-size: 8px; 
            padding: 1px 3px; 
            border-radius: 2px; 
            font-weight: bold; 
            z-index: 10;
        }
        
        .category-perfect, .category-best { 
            background: #4caf50; 
            color: white; 
        }
        
        .category-recommended { 
            background: #ffeb3b; 
            color: black; 
        }
        
        .bayes { 
            position: absolute; 
            bottom: 1px; 
            right: 1px; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 8px; 
            font-weight: bold; 
            color: black; 
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
            z-index: 10;
        }
        
        .player-votes { 
            position: absolute; 
            bottom: 1px; 
            left: 1px; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            font-size: 8px; 
            padding: 1px 2px; 
            border-radius: 2px; 
            font-weight: bold; 
            z-index: 10;
            line-height: 1.1;
        }
        
        .loading {
            text-align: center;
            padding: 2em;
            font-size: 18px;
            color: #666;
        }
        
        @media print {
            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print { display: none !important; }
            
            @page {
                margin: 0.5in;
                size: letter;
                @top-left { content: "" !important; }
                @top-center { content: "" !important; }
                @top-right { content: "" !important; }
                @bottom-left { content: "" !important; }
                @bottom-center { content: "" !important; }
                @bottom-right { content: "" !important; }
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        Loading games data...<br>
        <small style="color:#666; margin-top:1em; display:block; font-size:12px; line-height:1.4;">
            ðŸ’¡ <strong>For clean printing:</strong> In your browser's Print Settings, turn off "Headers and footers" to remove URL, page numbers, and date/time from the printout.
        </small>
    </div>
    
    <div id="printContent" style="display: none;">
        <div class="header" id="header"></div>
        <div class="grid" id="grid"></div>
        <div class="custom-footer" id="customFooter"></div>
    </div>

    <script>
        function getPrintData() {
            try {
                const stored = localStorage.getItem('bgg_print_data');
                if (!stored) {
                    throw new Error('No print data found');
                }
                
                const data = JSON.parse(stored);
                
                const age = Date.now() - data.timestamp;
                if (age > 300000) {
                    throw new Error('Print data expired');
                }
                
                return data;
            } catch (error) {
                console.error('Error getting print data:', error);
                return null;
            }
        }

        function initializePrintView() {
            try {
                const printData = getPrintData();
                
                if (!printData) {
                    document.getElementById('loading').innerHTML = 'Error: No valid print data found. Please try again from the main page.';
                    return;
                }
                
                const { username, playerCount, games, printOptions = {} } = printData;
                
                const options = {
                    topLeft: 'rank',
                    topRight: 'category',
                    bottomLeft: 'playerVotes', 
                    bottomRight: 'bayes',
                    ...printOptions
                };
                
                const header = document.getElementById('header');
                header.textContent = `${username} - Top 120 Games${playerCount && playerCount !== 'All' ? ` (${playerCount} Players)` : ''}`;
                
                const footer = document.getElementById('customFooter');
                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                footer.textContent = `${timestamp}`;
                
                const grid = document.getElementById('grid');
                const top120 = games.slice(0, 120);
                
                for (let i = 0; i < 120; i++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    
                    if (i < top120.length && top120[i]) {
                        const game = top120[i];
                        
                        if (options.topLeft === 'rank') {
                            const rank = document.createElement('div');
                            rank.className = 'rank';
                            rank.textContent = i + 1;
                            tile.appendChild(rank);
                        }
                        
                        if (options.topRight === 'category' && game.category !== 'supported') {
                            const category = document.createElement('div');
                            category.className = `category category-${game.category}`;
                            const categoryMap = {
                                'perfect': 'P',
                                'best': 'B', 
                                'recommended': 'R'
                            };
                            category.textContent = categoryMap[game.category];
                            tile.appendChild(category);
                        }
                        
                        if (options.bottomRight === 'bayes' && game.bayesAverage && game.bayesAverage > 0) {
                            const bayes = document.createElement('div');
                            bayes.className = 'bayes';
                            
                            const score = Math.max(0, Math.min(10, game.bayesAverage));
                            let red, green, blue = 0;
                            
                            if (score < 2) {
                                red = 200 + Math.round(55 * (score / 2));
                                green = Math.round(20 * (score / 2));
                            } else if (score < 4) {
                                red = 255;
                                green = Math.round(80 * ((score - 2) / 2));
                            } else if (score < 5.5) {
                                red = 255;
                                green = 80 + Math.round(95 * ((score - 4) / 1.5));
                            } else if (score < 7) {
                                red = 255;
                                green = 175 + Math.round(80 * ((score - 5.5) / 1.5));
                            } else if (score < 8.5) {
                                red = 255 - Math.round(100 * ((score - 7) / 1.5));
                                green = 255;
                            } else {
                                red = 155 - Math.round(155 * ((score - 8.5) / 1.5));
                                green = 255;
                            }
                            
                            bayes.style.backgroundColor = `rgb(${red}, ${green}, ${blue})`;
                            bayes.textContent = Math.ceil(game.bayesAverage * 10) / 10;
                            tile.appendChild(bayes);
                        }
                        
                        if (options.bottomLeft === 'playerVotes' && game.playerVotes && game.playerVotes.length > 0) {
                            const playerVotes = document.createElement('div');
                            playerVotes.className = 'player-votes';
                            
                            const currentPlayerVotes = game.playerVotes.find(vote => 
                                vote.playerCount === parseInt(playerCount)
                            );
                            
                            if (currentPlayerVotes) {
                                const best = currentPlayerVotes.best || 0;
                                const recommended = currentPlayerVotes.recommended || 0;
                                const notRecommended = currentPlayerVotes.notRecommended || 0;
                                
                                playerVotes.innerHTML = `B:${best}<br>R:${recommended}<br>N:${notRecommended}`;
                            } else {
                                playerVotes.innerHTML = 'B:0<br>R:0<br>N:0';
                            }
                            
                            tile.appendChild(playerVotes);
                        }
                        
                        if (game.thumbnail) {
                            const img = document.createElement('img');
                            img.src = game.thumbnail;
                            img.alt = game.name || 'Game thumbnail';
                            img.onerror = function() {
                                this.style.display = 'none';
                            };
                            tile.appendChild(img);
                        }
                    }
                    
                    grid.appendChild(tile);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('printContent').style.display = 'block';
                
                setTimeout(() => {
                    window.print();
                }, 1000);
                
            } catch (error) {
                console.error('Error initializing print view:', error);
                document.getElementById('loading').innerHTML = 'Error loading games data. Please try again.';
            }
        }

        window.addEventListener('load', initializePrintView);
    </script>
</body>
</html>
