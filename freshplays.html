<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>Fresh Plays - Boardgames Hub</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f7f7fa;
            color: #222;
        }
        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 2em 1em 1em 1em;
            box-sizing: border-box;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        h1 {
            font-size: 1.7em;
            margin-bottom: 1em;
            text-align: center;
        }
        .play-list {
            margin-top: 1em;
        }
        .play-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            margin-bottom: 1em;
            padding: 1em 1.2em;
            display: flex;
            flex-direction: column;
        }
        .play-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 0.2em;
        }
        .play-details {
            font-size: 0.98em;
            color: #555;
        }
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 14px;
            padding: 2em 2em 1.5em 2em;
            min-width: 280px;
            max-width: 90vw;
            box-shadow: 0 8px 32px #0003;
            text-align: center;
        }
        .modal-content input {
            font-size: 1.1em;
            padding: 0.5em 1em;
            border-radius: 8px;
            border: 1px solid #bbb;
            margin-bottom: 1em;
            width: 80%;
        }
        .modal-content button {
            background: #a020f0;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7em 2em;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <a id="homeBtn" href="index.html" style="position:fixed; left:calc(50vw - 215px); top:24px; z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:flex; align-items:center; justify-content:center; max-width:430px; text-decoration:none;">
        <span style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;"><svg width="32" height="32" viewBox="0 0 32 32" style="display:block; margin:auto;" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#1976d2"/><path d="M20 10L12 16L20 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
    </a>
    <button id="scrollTopBtn" style="position:fixed; right:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8679;</button>
    <button id="scrollBottomBtn" style="position:fixed; left:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8681;</button>
    <div class="container">
        <h1>Fresh Plays</h1>
        <div id="playList" class="play-list">
            <div style="text-align:center; color:#888; font-size:1.1em;">Loading...</div>
        </div>
    </div>
    <!-- Username modal removed, always use sportomax -->
    <script>
    // Up/Down arrow logic
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const scrollBottomBtn = document.getElementById('scrollBottomBtn');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollTopBtn.style.display = 'flex';
        } else {
            scrollTopBtn.style.display = 'none';
        }
        if ((window.innerHeight + window.scrollY) < document.body.offsetHeight - 300) {
            scrollBottomBtn.style.display = 'flex';
        } else {
            scrollBottomBtn.style.display = 'none';
        }
    });
    scrollTopBtn.onclick = () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    scrollBottomBtn.onclick = () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };
    const playList = document.getElementById('playList');
    async function fetchThumbnail(gameId) {
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${gameId}`);
            if (!resp.ok) return '';
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const thumb = doc.querySelector('thumbnail');
            return thumb ? thumb.textContent : '';
        } catch {
            return '';
        }
    }

    function showPlayModal(play) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        const content = document.createElement('div');
        content.className = 'modal-content';
        content.style.maxWidth = '430px';
        content.style.width = '96vw';
        content.style.boxSizing = 'border-box';
        content.style.padding = '1.2em 0.7em 1em 0.7em';

        // Extract readable details
        const gameName = play.querySelector('item')?.getAttribute('name') || 'Unknown';
        const gameId = play.querySelector('item')?.getAttribute('objectid') || '';
        const date = play.getAttribute('date') || '';
        const location = play.getAttribute('location') || '';
        const comments = play.querySelector('comments')?.textContent || '';
        const players = Array.from(play.querySelectorAll('players player')).map(p => ({
            name: p.getAttribute('name') || '',
            username: p.getAttribute('username') || '',
            score: p.getAttribute('score') || '',
            win: p.getAttribute('win') || '',
            color: p.getAttribute('color') || ''
        }));

        let html = `<h2 style='font-size:1.2em;'>Play Details</h2>`;
        html += `<div style='font-size:1em; text-align:left; background:#f7f7fa; padding:1em; border-radius:8px; max-height:48vh; overflow:auto;'>`;
        html += `<b>Game:</b> ${gameName}<br>`;
        html += `<b>Date:</b> ${date}<br>`;
        html += `<b>Location:</b> ${location || '<span style="color:#888">(none)</span>'}<br>`;
        if (comments) html += `<b>Comments:</b> ${comments}<br>`;
        if (players.length) {
            html += `<b>Players:</b><ul style='margin:0.3em 0 0.7em 1em; padding:0;'>`;
            players.forEach(p => {
                html += `<li>${p.name || p.username || 'Unknown'}${p.score ? ` (Score: ${p.score})` : ''}${p.win === '1' ? ' üèÜ' : ''}${p.color ? ` [${p.color}]` : ''}</li>`;
            });
            html += `</ul>`;
        }
        html += `</div>`;
        html += `<button id='closePlayModalBtn' style='margin-top:1em; background:#1976d2; color:#fff; font-size:1em; padding:0.6em 2em; border-radius:8px; border:none;'>Close</button>`;

        content.innerHTML = html;
        modal.appendChild(content);
        document.body.appendChild(modal);
        document.getElementById('closePlayModalBtn').onclick = () => {
            document.body.removeChild(modal);
        };
    }

    function escapeHtml(str) {
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    async function fetchPlays(username) {
        playList.innerHTML = '<div style="text-align:center; color:#888; font-size:1.1em;">Loading...</div>';
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/plays?username=${encodeURIComponent(username)}`);
            if (!resp.ok) throw new Error('Failed to fetch plays');
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const items = Array.from(doc.querySelectorAll('play'));
            if (items.length === 0) {
                playList.innerHTML = '<div style="text-align:center; color:#888;">No plays found.</div>';
                return;
            }
            playList.innerHTML = '';
            for (const play of items) {
                const date = play.getAttribute('date') || '';
                const location = play.getAttribute('location') || '';
                const gameName = play.querySelector('item')?.getAttribute('name') || 'Unknown';
                const gameId = play.querySelector('item')?.getAttribute('objectid') || '';
                const bggLink = gameId ? `https://boardgamegeek.com/boardgame/${gameId}` : '';
                let thumbUrl = '';
                if (gameId) {
                    thumbUrl = await fetchThumbnail(gameId);
                }
                const card = document.createElement('div');
                card.className = 'play-card';
                card.innerHTML = `
                    <div style='display:flex; align-items:center;'>
                        ${thumbUrl ? `<img src='${thumbUrl}' alt='${gameName} thumbnail' style='width:48px; height:48px; border-radius:8px; margin-right:1em; object-fit:cover;'>` : ''}
                        <div class='play-title'>${gameName}</div>
                    </div>
                    <div class='play-details'>
                        <b>Date:</b> ${date}<br>
                        <b>Location:</b> ${location}<br>
                        ${bggLink ? `<a href='${bggLink}' target='_blank' style='color:#1976d2;'>View on BGG</a>` : ''}
                        <br><button class='btn' style='margin-top:0.7em; background:#1976d2; color:#fff; font-size:0.95em; padding:0.5em 1.2em; border-radius:8px; border:none; box-shadow:none;' onclick='showPlayModal(window._playRefs[${playList.children.length}])'>Full Play Data</button>
                    </div>
                `;
                playList.appendChild(card);
                window._playRefs = window._playRefs || [];
                window._playRefs.push(play);
            }
        } catch (e) {
            playList.innerHTML = `<div style='text-align:center; color:#c00;'>Error: ${e.message}</div>`;
        }
    }
    // Always use sportomax, no prompt
    fetchPlays('sportomax');
    </script>
</body>
</html>
