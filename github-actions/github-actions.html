<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé≤ BGG Collection ‚Äî sportomax (Full Stats)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0.5rem;
    }
    h1 { text-align: center; margin-bottom: 0.5rem; }
    button {
      display: inline-block;
      margin: 0.25rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #buttonContainer { text-align: center; margin-bottom: 0.5rem; }
    #status { text-align: center; font-size: 0.9rem; margin-bottom: 0.5rem; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      overflow-x: auto;
      display: block;
    }
    th, td {
      padding: 0.3rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #007aff;
      color: white;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) { background: #f2f2f2; }
  </style>
</head>
<body>
  <h1>üé≤ BGG Collection ‚Äî sportomax</h1>
  <div id="buttonContainer">
    <button id="fetchLiveBtn">Fetch Live</button>
    <button id="loadStoredBtn">Load Stored</button>
  </div>
  <div id="status"></div>
  <table id="collectionTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script>
    const username = "sportomax";
    const liveURL = `https://boardgamegeek.com/xmlapi2/collection?username=${username}&own=1&stats=1`;
    const storedURL = "./collection.xml";
    const statusDiv = document.getElementById("status");

    const columns = [
      "Idx",
      "api_date",
      "Object ID",
      "Collection ID",
      "Name",
      "Year",
      "Subtype",
      "Image",
      "Thumbnail",
      "Own",
      "Prev Owned",
      "For Trade",
      "Want",
      "Want to Play",
      "Want to Buy",
      "Wishlist",
      "Wishlist Priority",
      "Preordered",
      "Min Players",
      "Max Players",
      "Playing Time",
      "Min Playtime",
      "Max Playtime",
      "Num Owned",
      "Average Rating",
      "Bayes Avg",
      "Stddev",
      "Median",
      "Num Ratings",
      "Rank (Board Game)",
      "Rank (Family)",
      "User Rating",
      "Weight",
      "Last Modified",
      "Num Plays"
    ];

    function updateStatus(msg, color = "#333") {
      statusDiv.style.color = color;
      statusDiv.textContent = msg;
    }

    async function fetchWithRetries(url, retries = [2000, 4000, 8000]) {
      for (let i = 0; i <= retries.length; i++) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          return text;
        } catch (err) {
          if (i < retries.length) {
            updateStatus(`Fetch failed. Retrying in ${retries[i]/1000}s‚Ä¶`, "red");
            await new Promise(r => setTimeout(r, retries[i]));
          } else {
            throw err;
          }
        }
      }
    }

    function buildTableHeader() {
      const thead = document.querySelector("#collectionTable thead");
      thead.innerHTML = "";
      const tr = document.createElement("tr");
      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    function parseAndDisplay(xmlText) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "application/xml");
      const items = xml.querySelectorAll("item");
      const tbody = document.querySelector("#collectionTable tbody");
      tbody.innerHTML = "";

      // Get current date/time as api_date (ISO string, local time)
      const apiDate = new Date().toLocaleString();

      items.forEach((item, idx) => {
        const stats = item.querySelector("stats");
        const rating = stats?.querySelector("rating");
        const ranks = rating?.querySelectorAll("rank");
        let rankBoard = "";
        let rankFamily = "";

        ranks?.forEach(r => {
          const type = r.getAttribute("friendlyname") || "";
          if (type.includes("Board Game Rank")) rankBoard = r.getAttribute("value");
          if (type.includes("Family Game Rank")) rankFamily = r.getAttribute("value");
        });

        const status = item.querySelector("status");

        const rowData = [
          (idx + 1).toString(),
          apiDate,
          item.getAttribute("objectid") || "",
          item.getAttribute("collid") || "",
          item.querySelector("name")?.textContent || "",
          item.querySelector("yearpublished")?.textContent || "",
          item.getAttribute("subtype") || "",
          item.querySelector("image")?.textContent || "",
          item.querySelector("thumbnail")?.textContent || "",
          status?.getAttribute("own") || "",
          status?.getAttribute("prevowned") || "",
          status?.getAttribute("fortrade") || "",
          status?.getAttribute("want") || "",
          status?.getAttribute("wanttoplay") || "",
          status?.getAttribute("wanttobuy") || "",
          status?.getAttribute("wishlist") || "",
          status?.getAttribute("wishlistpriority") || "",
          status?.getAttribute("preordered") || "",
          stats?.getAttribute("minplayers") || "",
          stats?.getAttribute("maxplayers") || "",
          stats?.getAttribute("playingtime") || "",
          stats?.getAttribute("minplaytime") || "",
          stats?.getAttribute("maxplaytime") || "",
          stats?.getAttribute("numowned") || "",
          rating?.querySelector("average")?.getAttribute("value") || "",
          rating?.querySelector("bayesaverage")?.getAttribute("value") || "",
          rating?.querySelector("stddev")?.getAttribute("value") || "",
          rating?.querySelector("median")?.getAttribute("value") || "",
          rating?.querySelector("usersrated")?.getAttribute("value") || "",
          rankBoard,
          rankFamily,
          rating?.getAttribute("value") || "",
          rating?.querySelector("averageweight")?.getAttribute("value") || "",
          status?.getAttribute("lastmodified") || "",
          item.querySelector("numplays")?.textContent || ""
        ];

        const tr = document.createElement("tr");
        rowData.forEach((val, idx) => {
          const td = document.createElement("td");
          // Show image and thumbnail as images
          if (columns[idx] === "Image" && val) {
            const img = document.createElement("img");
            img.src = val;
            img.alt = "Image";
            img.style.maxWidth = "60px";
            img.style.maxHeight = "40px";
            td.appendChild(img);
          } else if (columns[idx] === "Thumbnail" && val) {
            const img = document.createElement("img");
            img.src = val;
            img.alt = "Thumbnail";
            img.style.maxWidth = "60px";
            img.style.maxHeight = "40px";
            td.appendChild(img);
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      updateStatus(`Loaded ${items.length} games ‚úÖ`, "green");
    }

    async function fetchLive() {
      updateStatus("Fetching live data‚Ä¶ ‚è≥");
      try {
        const xmlText = await fetchWithRetries(liveURL);
        buildTableHeader();
        parseAndDisplay(xmlText);
      } catch (err) {
        updateStatus("‚ùå Failed to fetch live data: " + err.message, "red");
      }
    }

    async function loadStored() {
      updateStatus("Loading stored data‚Ä¶ ‚è≥");
      try {
        const xmlText = await fetchWithRetries(storedURL);
        buildTableHeader();
        parseAndDisplay(xmlText);
      } catch (err) {
        updateStatus("‚ùå Failed to load stored data: " + err.message, "red");
      }
    }

    document.getElementById("fetchLiveBtn").addEventListener("click", fetchLive);
    document.getElementById("loadStoredBtn").addEventListener("click", loadStored);
  </script>
</body>
</html>
