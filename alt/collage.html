<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>Boardgame Collage</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f7f7fa;
            color: #222;
        }
        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 2em 1em 1em 1em;
            box-sizing: border-box;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        h1 {
            font-size: 1.7em;
            margin-bottom: 1em;
            text-align: center;
        }
        #searchBar {
            display: flex;
            justify-content: center;
            margin-bottom: 1em;
        }
        #searchInput {
            font-size: 1.1em;
            padding: 0.5em 1em;
            border-radius: 8px;
            border: 1px solid #bbb;
            width: 60%;
            max-width: 180px;
        }
        #searchBtn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7em 2em;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 1em;
        }
        #results {
            margin-bottom: 2em;
        }
        .result-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            margin-bottom: 1em;
            padding: 1em 1.2em;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .result-thumb {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            margin-right: 1em;
            object-fit: cover;
            flex-shrink: 0;
        }
        .result-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .result-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 0.2em;
        }
        .result-details {
            font-size: 0.98em;
            color: #555;
        }
        .add-btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.5em 1.2em;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 1em;
        }
        #collageGrid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1em;
            margin-top: 1em;
            margin-bottom: 2em;
        }
        .collage-item {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            padding: 0.5em;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            position: relative;
        }
        .collage-thumb {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin-bottom: 0.5em;
        }
        .collage-title {
            font-size: 1em;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.2em;
        }
        .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #c00;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1em;
            cursor: pointer;
        }
        #exportBtn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7em 2em;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 0 auto 2em auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Boardgame Collage</h1>
        <div id="searchBar">
            <input id="searchInput" type="text" placeholder="Search boardgames...">
            <button id="searchBtn">Search</button>
            <button id="hideSearchBtn" style="background:#bbb; color:#222; border:none; border-radius:8px; padding:0.7em 1.2em; font-size:1.1em; font-weight:600; cursor:pointer; margin-left:1em;">Done</button>
        </div>
        <div id="results"></div>
        <h2 style="text-align:center; font-size:1.2em; margin-bottom:0.5em;">Collage</h2>
        <div id="collageGrid"></div>
        <button id="exportBtn">Export as Image</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const hideSearchBtn = document.getElementById('hideSearchBtn');
    const resultsDiv = document.getElementById('results');
    const collageGrid = document.getElementById('collageGrid');
    const exportBtn = document.getElementById('exportBtn');
    let collageGames = [];
    let allResults = [];

    async function fetchResults(query) {
        if (!query) {
            resultsDiv.innerHTML = '';
            allResults = [];
            return;
        }
        resultsDiv.innerHTML = '<div style="text-align:center; color:#888; font-size:1.1em;">Searching...</div>';
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/search?query=${encodeURIComponent(query)}&type=boardgame`);
            if (!resp.ok) throw new Error('Failed to fetch search results');
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            allResults = Array.from(doc.querySelectorAll('item')).map(item => {
                return {
                    name: item.querySelector('name')?.getAttribute('value') || 'Unknown',
                    objectId: item.getAttribute('id') || '',
                    year: item.querySelector('yearpublished')?.getAttribute('value') || '',
                    thumbUrl: '',
                    item
                };
            });
            // Fetch thumbnails async
            allResults.forEach((result, i) => {
                fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${result.objectId}`).then(r => r.text()).then(xmlText => {
                    const doc2 = parser.parseFromString(xmlText, 'text/xml');
                    const thumb = doc2.querySelector('thumbnail');
                    if (thumb) {
                        result.thumbUrl = thumb.textContent;
                        const img = document.getElementById(`result-thumb-${i}`);
                        if (img) {
                            img.src = thumb.textContent;
                            img.style.display = 'block';
                        }
                    }
                });
            });
            renderResults();
        } catch (e) {
            resultsDiv.innerHTML = `<div style='text-align:center; color:#c00;'>Error: ${e.message}</div>`;
            allResults = [];
        }
    }

    function renderResults(filter = '') {
        let filtered = allResults;
        if (filter) {
            const f = filter.toLowerCase();
            filtered = allResults.filter(r => r.name.toLowerCase().includes(f));
        }
        if (filtered.length === 0) {
            resultsDiv.innerHTML = '<div style="text-align:center; color:#888;">No games found.</div>';
            return;
        }
        let html = '';
        filtered.forEach((result, i) => {
            html += `<div class='result-card'>
                <img src='${result.thumbUrl}' alt='' class='result-thumb' id='result-thumb-${i}' style='width:64px; height:64px; border-radius:10px; margin-right:1em; object-fit:cover;${result.thumbUrl ? '' : 'display:none;'}'>
                <div class='result-info'>
                    <div class='result-title'>${result.name}</div>
                    <div class='result-details'><b>Year Published:</b> ${result.year || 'N/A'}</div>
                </div>
                <button class='add-btn' data-idx='${i}'>Add</button>
            </div>`;
        });
        resultsDiv.innerHTML = html;
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.onclick = () => {
                const idx = btn.getAttribute('data-idx');
                const result = filtered[idx];
                collageGames.push({ name: result.name, objectId: result.objectId, thumbUrl: result.thumbUrl });
                renderCollage();
            };
        });
    }

    searchBtn.onclick = () => {
        fetchResults(searchInput.value.trim());
    };

    searchInput.addEventListener('input', () => {
        renderResults(searchInput.value.trim());
    });

    hideSearchBtn.onclick = () => {
        document.getElementById('searchBar').style.display = 'none';
        resultsDiv.style.display = 'none';
    };

    function renderCollage() {
        collageGrid.innerHTML = '';
        collageGames.forEach((game, idx) => {
            const div = document.createElement('div');
            div.className = 'collage-item';
            div.draggable = true;
            div.innerHTML = `
                <img src='${game.thumbUrl}' alt='${game.name} thumbnail' class='collage-thumb'>
                <div class='collage-title'>${game.name}</div>
                <button class='remove-btn' title='Remove'>&times;</button>
            `;
            // Remove button
            div.querySelector('.remove-btn').onclick = () => {
                collageGames.splice(idx, 1);
                renderCollage();
            };
            // Drag and drop
            div.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', idx);
            });
            div.addEventListener('dragover', e => {
                e.preventDefault();
            });
            div.addEventListener('drop', e => {
                e.preventDefault();
                const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                if (fromIdx !== idx) {
                    const moved = collageGames.splice(fromIdx, 1)[0];
                    collageGames.splice(idx, 0, moved);
                    renderCollage();
                }
            });
            collageGrid.appendChild(div);
        });
    }

    exportBtn.onclick = () => {
        html2canvas(collageGrid).then(canvas => {
            const link = document.createElement('a');
            link.download = 'boardgame-collage.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    };
    </script>
</body>
</html>
