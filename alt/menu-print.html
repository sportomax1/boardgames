<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGG Top 120 Print View</title>
    <style>
        @page { 
            size: letter; 
            margin: 0.5in; 
        }
        
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: white;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 0.25in; 
            font-size: 16px; 
            font-weight: bold; 
            color: #333;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            grid-template-rows: repeat(12, 1fr); 
            gap: 2px; 
            width: 7.5in; 
            height: 9in; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
        }
        
        .tile { 
            position: relative; 
            border: 1px solid #ddd; 
            background: #f9f9f9; 
            overflow: hidden;
        }
        
        .tile img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block;
            background: #f5f5f5;
        }
        
        .rank { 
            position: absolute; 
            top: 1px; 
            left: 1px; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            font-size: 6px; 
            padding: 1px 2px; 
            border-radius: 2px; 
            font-weight: bold; 
            z-index: 10;
        }
        
        .category { 
            position: absolute; 
            top: 1px; 
            right: 1px; 
            font-size: 7px; 
            padding: 1px 3px; 
            border-radius: 2px; 
            font-weight: bold; 
            z-index: 10;
        }
        
        .category-perfect, .category-best { 
            background: #4caf50; 
            color: white; 
        }
        
        .category-recommended { 
            background: #ffeb3b; 
            color: black; 
        }
        
        .bayes { 
            position: absolute; 
            bottom: 1px; 
            right: 1px; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 5px; 
            font-weight: bold; 
            color: white; 
            text-shadow: 0 0 2px rgba(0,0,0,0.8);
            z-index: 10;
        }
        
        .loading {
            text-align: center;
            padding: 2em;
            font-size: 18px;
            color: #666;
        }
        
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading games data...</div>
    
    <div id="printContent" style="display: none;">
        <div class="header" id="header"></div>
        <div class="grid" id="grid"></div>
    </div>

    <script>
        // Get data from localStorage
        function getPrintData() {
            try {
                const stored = localStorage.getItem('bgg_print_data');
                if (!stored) {
                    throw new Error('No print data found');
                }
                
                const data = JSON.parse(stored);
                
                // Check if data is recent (within 5 minutes)
                const age = Date.now() - data.timestamp;
                if (age > 300000) { // 5 minutes
                    throw new Error('Print data expired');
                }
                
                return data;
            } catch (error) {
                console.error('Error getting print data:', error);
                return null;
            }
        }

        // Initialize the print view
        function initializePrintView() {
            try {
                const printData = getPrintData();
                
                if (!printData) {
                    document.getElementById('loading').innerHTML = 'Error: No valid print data found. Please try again from the main page.';
                    return;
                }
                
                const { username, playerCount, games } = printData;
                
                // Set header
                const header = document.getElementById('header');
                header.textContent = `BGG: ${username} - Top 120 Games (${playerCount} Players)`;
                
                // Build grid
                const grid = document.getElementById('grid');
                const top120 = games.slice(0, 120);
                
                for (let i = 0; i < 120; i++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    
                    if (i < top120.length && top120[i]) {
                        const game = top120[i];
                        
                        // Add rank number (smaller font)
                        const rank = document.createElement('div');
                        rank.className = 'rank';
                        rank.textContent = i + 1;
                        tile.appendChild(rank);
                        
                        // Add category letter with colors (P, B = green; R = yellow; S = none)
                        if (game.category !== 'supported') {
                            const category = document.createElement('div');
                            category.className = `category category-${game.category}`;
                            const categoryMap = {
                                'perfect': 'P',
                                'best': 'B', 
                                'recommended': 'R'
                            };
                            category.textContent = categoryMap[game.category];
                            tile.appendChild(category);
                        }
                        
                        // Add bayes average as gradient circle (red to green)
                        if (game.bayesAverage && game.bayesAverage > 0) {
                            const bayes = document.createElement('div');
                            bayes.className = 'bayes';
                            
                            // Calculate gradient color (red to green based on 0-10 scale)
                            const normalizedScore = Math.max(0, Math.min(10, game.bayesAverage)) / 10;
                            const red = Math.round(255 * (1 - normalizedScore));
                            const green = Math.round(255 * normalizedScore);
                            bayes.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
                            
                            bayes.textContent = Math.ceil(game.bayesAverage * 10) / 10;
                            tile.appendChild(bayes);
                        }
                        
                        // Add game thumbnail
                        if (game.thumbnail) {
                            const img = document.createElement('img');
                            img.src = game.thumbnail;
                            img.alt = game.name || 'Game thumbnail';
                            img.onerror = function() {
                                this.style.display = 'none';
                            };
                            tile.appendChild(img);
                        }
                    }
                    
                    grid.appendChild(tile);
                }
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('printContent').style.display = 'block';
                
                // Auto-print after a short delay
                setTimeout(() => {
                    window.print();
                }, 1000);
                
            } catch (error) {
                console.error('Error initializing print view:', error);
                document.getElementById('loading').innerHTML = 'Error loading games data. Please try again.';
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initializePrintView);
    </script>
</body>
</html>