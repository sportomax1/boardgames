<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>BGG Geeklist Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f7f7fa;
            color: #222;
        }
        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 2em 1em 1em 1em;
            box-sizing: border-box;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        h1 {
            font-size: 1.7em;
            margin-bottom: 1em;
            text-align: center;
        }
        .game-list {
            margin-top: 1em;
        }
        .game-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            margin-bottom: 1em;
            padding: 1em 1.2em;
            display: flex;
            flex-direction: row;
            align-items: center;
            position: relative;
        }
        .status-emoji {
            position: absolute;
            top: 0.5em;
            right: 0.5em;
            font-size: 1.2em;
            z-index: 1;
        }
        .game-thumb {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            margin-right: 1em;
            object-fit: cover;
            flex-shrink: 0;
        }
        .game-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .game-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 0.2em;
        }
        .game-details {
            font-size: 0.98em;
            color: #555;
        }
        #geeklistPrompt {
            margin-bottom: 1.5em;
            text-align: center;
        }
        #geeklistIdInput {
            font-size: 1.1em;
            padding: 0.5em 1em;
            border-radius: 8px;
            border: 1px solid #bbb;
            width: 60%;
            max-width: 180px;
        }
        #loadGeeklistBtn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7em 2em;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 1em;
        }
    </style>
</head>
<body>
    <a id="homeBtn" href="index.html" style="position:fixed; left:calc(50vw - 215px); top:24px; z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:flex; align-items:center; justify-content:center; max-width:430px; text-decoration:none;">
        <span style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;"><svg width="32" height="32" viewBox="0 0 32 32" style="display:block; margin:auto;" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#1976d2"/><path d="M20 10L12 16L20 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
    </a>
    <div class="container">
        <h1>BGG Geeklist Viewer</h1>
        <div id="geeklistPrompt">
            <label for="geeklistIdInput" style="font-size:1.1em;">Enter Geeklist ID:</label>
            <input id="geeklistIdInput" type="number" min="1" placeholder="e.g. 11205">
            <button id="loadGeeklistBtn">Load Geeklist</button>
        </div>
        <div id="gamesCardWrapper">
            <div style="text-align:center; color:#888; font-size:1.1em;">Enter a Geeklist ID above and click Load.</div>
        </div>
        <button id="scrollTopBtn" style="position:fixed; right:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8679;</button>
        <button id="scrollBottomBtn" style="position:fixed; left:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8681;</button>
    </div>
    <script>
    // User collection tracking
    let userCollection = new Set();
    let userWantToPlay = new Set();
    let userWantToBuy = new Set();
    let userWantInTrade = new Set();
    let userPrevOwned = new Set();
    let userTradingAway = new Set();
    
    async function fetchUserCollections() {
        // Fetch user's collection
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax&own=1');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                userCollection = new Set(items.map(i => i.getAttribute('objectid')));
            }
        } catch {}
        // Fetch user's want to play
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax&wanttoplay=1');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                userWantToPlay = new Set(items.map(i => i.getAttribute('objectid')));
            }
        } catch {}
        // Fetch user's want to buy
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax&wanttobuy=1');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                userWantToBuy = new Set(items.map(i => i.getAttribute('objectid')));
            }
        } catch {}
        // Fetch user's want in trade
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax&wantintrade=1');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                userWantInTrade = new Set(items.map(i => i.getAttribute('objectid')));
            }
        } catch {}
        // Fetch user's previously owned
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax&prevowned=1');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                userPrevOwned = new Set(items.map(i => i.getAttribute('objectid')));
            }
        } catch {}
        // Fetch user's trading away
        try {
            const resp = await fetch('https://boardgamegeek.com/xmlapi2/collection?username=sportomax&fortrade=1');
            if (resp.ok) {
                const xml = await resp.text();
                const parser = new window.DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item'));
                userTradingAway = new Set(items.map(i => i.getAttribute('objectid')));
            }
        } catch {}
    }
    
    function getStatusEmoji(objectId) {
        if (!objectId) return '';
        if (userCollection.has(objectId)) return '‚úÖ';
        if (userWantToPlay.has(objectId)) return 'üéÆ';
        if (userWantToBuy.has(objectId)) return 'üõí';
        if (userWantInTrade.has(objectId)) return 'üîÑ';
        if (userPrevOwned.has(objectId)) return '‚è™';
        if (userTradingAway.has(objectId)) return 'üì§';
        return '';
    }

    async function fetchThingDetails(objectId) {
        if (!objectId) return {};
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${objectId}`);
            if (!resp.ok) return {};
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const thumb = doc.querySelector('thumbnail');
            const year = doc.querySelector('yearpublished');
            const desc = doc.querySelector('description');
            return {
                thumbnail: thumb ? thumb.textContent : '',
                year: year ? year.textContent : '',
                description: desc ? desc.textContent : ''
            };
        } catch {
            return {};
        }
    }

    async function fetchGeeklist(geeklistId) {
        const gamesCardWrapper = document.getElementById('gamesCardWrapper');
        gamesCardWrapper.innerHTML = '<div style="text-align:center; color:#888; font-size:1.1em;">Loading Geeklist and User Collections...</div>';
        
        // Fetch user collections first
        await fetchUserCollections();
        
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi/geeklist/${geeklistId}`);
            if (!resp.ok) throw new Error('Failed to fetch Geeklist');
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const items = Array.from(doc.querySelectorAll('item'));
            if (items.length === 0) {
                gamesCardWrapper.innerHTML = '<div style="text-align:center; color:#888;">No items found in this Geeklist.</div>';
                return;
            }
            let html = '';
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const name = item.getAttribute('objectname') || 'Unknown';
                const objectType = item.getAttribute('objecttype') || '';
                const objectId = item.getAttribute('objectid') || '';
                const username = item.getAttribute('username') || '';
                const statusEmoji = getStatusEmoji(objectId);
                html += `<div class='game-card' id='geekcard-${i}'>
                    ${statusEmoji ? `<div class='status-emoji'>${statusEmoji}</div>` : ''}
                    <img src='' alt='' class='game-thumb' style='width:64px; height:64px; border-radius:10px; margin-right:1em; object-fit:cover; display:none;'>
                    <div class='game-info'>
                        <div class='game-title'>#${i + 1} ${name}</div>
                        <div class='game-details'>
                            <b>Type:</b> ${objectType}<br>
                            <b>BGG ID:</b> ${objectId}<br>
                            <b>Added by:</b> ${username}<br>
                            ${objectId ? `<a href='https://boardgamegeek.com/boardgame/${objectId}' target='_blank' style='color:#1976d2;'>View on BGG</a>` : ''}
                        </div>
                    </div>
                </div>`;
            }
            gamesCardWrapper.innerHTML = html;
            // Fetch thumbnails/details asynchronously and update cards
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const objectType = item.getAttribute('objecttype') || '';
                const objectId = item.getAttribute('objectid') || '';
                if (objectType === 'thing' && objectId) {
                    fetchThingDetails(objectId).then(details => {
                        const card = document.getElementById(`geekcard-${i}`);
                        if (card && details.thumbnail) {
                            const img = card.querySelector('.game-thumb');
                            if (img) {
                                img.src = details.thumbnail;
                                img.alt = `${item.getAttribute('objectname') || 'Game'} thumbnail`;
                                img.style.display = 'block';
                            }
                        }
                        if (card && details.year) {
                            const info = card.querySelector('.game-details');
                            if (info) {
                                info.innerHTML += `<b>Year:</b> ${details.year}<br>`;
                            }
                        }
                        if (card && details.description) {
                            const info = card.querySelector('.game-details');
                            if (info) {
                                info.innerHTML += `<span style='color:#888; font-size:0.95em;'>${details.description.substring(0,120)}${details.description.length>120?'...':''}</span><br>`;
                            }
                        }
                    });
                }
            }
        } catch (e) {
            gamesCardWrapper.innerHTML = `<div style='text-align:center; color:#c00;'>Error: ${e.message}</div>`;
        }
    }
    document.getElementById('loadGeeklistBtn').onclick = () => {
        const geeklistId = document.getElementById('geeklistIdInput').value.trim();
        if (!geeklistId || isNaN(geeklistId) || parseInt(geeklistId) < 1) {
            alert('Please enter a valid Geeklist ID.');
            return;
        }
        fetchGeeklist(geeklistId);
    };
    // Arrow button logic
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const scrollBottomBtn = document.getElementById('scrollBottomBtn');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollTopBtn.style.display = 'flex';
        } else {
            scrollTopBtn.style.display = 'none';
        }
        if ((window.innerHeight + window.scrollY) < document.body.offsetHeight - 300) {
            scrollBottomBtn.style.display = 'flex';
        } else {
            scrollBottomBtn.style.display = 'none';
        }
    });
    scrollTopBtn.onclick = () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    scrollBottomBtn.onclick = () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };
    </script>
</body>
</html>
