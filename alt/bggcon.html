<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>BGG CON Library</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f7f7fa;
            color: #222;
        }
        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 2em 1em 1em 1em;
            box-sizing: border-box;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        h1 {
            font-size: 1.7em;
            margin-bottom: 1em;
            text-align: center;
        }
        .game-list {
            margin-top: 1em;
        }
        .game-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            margin-bottom: 1em;
            padding: 1em 1.2em;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .game-thumb {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            margin-right: 1em;
            object-fit: cover;
            flex-shrink: 0;
        }
        .game-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .game-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 0.2em;
        }
        .game-details {
            font-size: 0.98em;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BGG CON Library</h1>
    <button id="sortBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.7em 2em; font-size:1.1em; font-weight:600; cursor:pointer; margin-bottom:1em; width:100%; max-width:320px;" disabled>Sort</button>
        <div id="sortModal" class="modal" style="display:none;">
            <div class="modal-content" style="max-width:430px; width:96vw; box-sizing:border-box; padding:1.2em 0.7em 1em 0.7em;">
                <h2 style="font-size:1.2em;">Sort Games</h2>
                <label style="font-size:1em;">Sort by:<br>
                    <select id="sortBy" style="font-size:1em; border-radius:8px; border:1px solid #bbb; padding:0.5em 1em; width:90%; margin-bottom:1em;">
                        <option value="date_created_desc">Date Created (Newest)</option>
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="max_play_time_asc">Max Play Time (Shortest)</option>
                        <option value="last_checkout_date_desc">Last Checkin Date (Newest)</option>
                        <option value="location_asc">Location (A-Z)</option>
                        <option value="bggrank_asc">BGG Rank (Lowest)</option>
                    </select>
                </label><br>
                <button id="applySortBtn" style="background:#1976d2; color:#fff; border:none; border-radius:8px; padding:0.7em 2em; font-size:1.1em; font-weight:600; cursor:pointer; margin-top:1em;">Apply</button>
                <button id="closeSortBtn" style="background:#bbb; color:#222; border:none; border-radius:8px; padding:0.7em 2em; font-size:1.1em; font-weight:600; cursor:pointer; margin-top:1em; margin-left:1em;">Close</button>
            </div>
        </div>
        <button id="scrollTopBtn" style="position:fixed; right:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8679;</button>
        <button id="scrollBottomBtn" style="position:fixed; left:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8681;</button>
        <div id="gamesCardWrapper">
            <div style="text-align:center; color:#888; font-size:1.1em;">Loading games...</div>
        </div>
        <button id="scrollTopBtn" style="position:fixed; right:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8679;</button>
        <button id="scrollBottomBtn" style="position:fixed; left:calc(50vw - 215px); bottom:calc(24px + env(safe-area-inset-bottom)); z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:none; align-items:center; justify-content:center; max-width:430px;">&#8681;</button>
        <a id="homeBtn" href="index.html" style="position:fixed; left:calc(50vw - 215px); top:24px; z-index:999; background:#1976d2; color:#fff; border:none; border-radius:50%; width:54px; height:54px; font-size:2em; box-shadow:0 2px 12px #0002; display:flex; align-items:center; justify-content:center; max-width:430px; text-decoration:none;">
            <span style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;"><svg width="32" height="32" viewBox="0 0 32 32" style="display:block; margin:auto;" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#1976d2"/><path d="M20 10L12 16L20 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
        </a>
    </div>
    <script>
    async function fetchThumbnail(bggId) {
        if (!bggId) return '';
        try {
            const resp = await fetch(`https://boardgamegeek.com/xmlapi2/thing?id=${bggId}`);
            if (!resp.ok) return '';
            const xml = await resp.text();
            const parser = new window.DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const thumb = doc.querySelector('thumbnail');
            return thumb ? thumb.textContent : '';
        } catch {
            return '';
        }
    }

    // Navigation arrow logic
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const scrollBottomBtn = document.getElementById('scrollBottomBtn');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollTopBtn.style.display = 'flex';
        } else {
            scrollTopBtn.style.display = 'none';
        }
        if ((window.innerHeight + window.scrollY) < document.body.offsetHeight - 300) {
            scrollBottomBtn.style.display = 'flex';
        } else {
            scrollBottomBtn.style.display = 'none';
        }
    });
    scrollTopBtn.onclick = () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    scrollBottomBtn.onclick = () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    async function fetchGames() {
        const gamesCardWrapper = document.getElementById('gamesCardWrapper');
        gamesCardWrapper.innerHTML = '<div style="text-align:center; color:#888; font-size:1.1em;">Loading all games...</div>';
        let allItems = [];
        let page = 1;
        let totalPages = 1;
        try {
            do {
                const apiUrl = `https://tabletop.events/api/library/0AEB11DA-2B7D-11EC-B400-855F800FD618/librarygames?page=${page}`;
                console.log(`Fetching API page: ${page} | URL: ${apiUrl}`);
                const resp = await fetch(apiUrl);
                if (!resp.ok) throw new Error('Failed to fetch games');
                const data = await resp.json();
                const items = data.result && Array.isArray(data.result.items) ? data.result.items : [];
                console.log(`API page ${page} returned ${items.length} items.`);
                if (page === 1 && data.paging && data.paging.total_pages) {
                    console.log(`Total pages reported by API: ${data.paging.total_pages}`);
                }
                if (items.length === 0) break;
                allItems = allItems.concat(items);
                if (data.paging && data.paging.total_pages) {
                    totalPages = data.paging.total_pages;
                }
                page++;
            } while (page <= totalPages);
            // Filter out games with blank location
            const filteredItems = allItems.filter(game => {
                let loc = game.Location || (game.custom_fields && game.custom_fields.Location);
                return loc !== undefined && loc !== null && String(loc).trim() !== '';
            });
            // Sort by date_updated descending
            filteredItems.sort((a, b) => {
                let da = new Date(a.date_updated || a.date_created || 0);
                let db = new Date(b.date_updated || b.date_created || 0);
                return db - da;
            });
            // Render cards immediately with placeholder
            let html = '';
            for (const [i, game] of filteredItems.entries()) {
                const name = game.name || game.Name || 'Unknown';
                const publisher = game.publisher_name || game.publisher || '';
                const location = game.Location || (game.custom_fields && game.custom_fields.Location) || '';
                const minPlayers = game.min_players || '';
                const maxPlayers = game.max_players || '';
                const minPlayTime = game.min_play_time || '';
                const maxPlayTime = game.max_play_time || '';
                const condition = game.overall_condition || '';
                const bggId = game.bgg_id || '';
                html += `<div class='game-card' id='gamecard-${i}' style='background:#fff; border-radius:12px; box-shadow:0 2px 12px #0001; margin-bottom:1em; padding:1em 1.2em;'>
                    <div style='font-size:1em; color:#1976d2; font-weight:700; margin-bottom:0.2em;'>#${i + 1}</div>
                    <img src='' alt='' class='game-thumb' style='width:80px; height:80px; border-radius:12px; margin-bottom:1em; object-fit:cover; display:none;'>
                    <div class='game-title' style='font-size:1.2em; font-weight:600; margin-bottom:0.3em;'>${name}</div>
                    <div class='game-details' style='font-size:0.98em; color:#555;'>
                        <b>Location:</b> <span style='color:#1976d2;'>${location}</span><br>
                        <b>Publisher:</b> ${publisher}<br>
                        <b>Players:</b> ${minPlayers} - ${maxPlayers}<br>
                        <b>Play Time:</b> ${minPlayTime} - ${maxPlayTime} min<br>
                        <b>Condition:</b> ${condition}<br>
                        ${bggId ? `<a href='https://boardgamegeek.com/boardgame/${bggId}' target='_blank' style='color:#1976d2;'>View on BGG</a>` : ''}
                    </div>
                </div>`;
            }
            gamesCardWrapper.innerHTML = html;
            // Fetch thumbnails asynchronously and update cards
            for (const [i, game] of filteredItems.entries()) {
                const bggId = game.bgg_id || '';
                if (bggId) {
                    fetchThumbnail(bggId).then(thumbUrl => {
                        if (thumbUrl) {
                            const card = document.getElementById(`gamecard-${i}`);
                            if (card) {
                                const img = card.querySelector('.game-thumb');
                                if (img) {
                                    img.src = thumbUrl;
                                    img.alt = `${game.name || 'Game'} thumbnail`;
                                    img.style.display = 'block';
                                }
                            }
                        }
                    });
                }
            }
        } catch (e) {
            gamesCardWrapper.innerHTML = `<div style='text-align:center; color:#c00;'>Error: ${e.message}</div>`;
        }
    }
    fetchGames();
    </script>
</body>
</html>
